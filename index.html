<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartPrice ‚Äî Tu compra inteligente (Map Fix - Scroll)</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Estilos (base mantenida + ajustes) -->
  <style>
    :root{
      --bg: #f8fafc;
      --accent: #1e88e5; --accent-2:#ff6d00; --accent-3:#5e35b1;
      --success:#43a047; --muted:#546e7a; --text:#333333;
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(180deg,#f8fafc 0%, #e3f2fd 100%); color:var(--text); font-size:16px; scroll-behavior:smooth; }
    .topbar{ position:sticky; top:0; z-index:1200; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; gap:12px; backdrop-filter: blur(8px); background:rgba(255,255,255,0.95); border-bottom:1px solid rgba(0,0,0,0.05); }
    .brand{ display:flex; gap:12px; align-items:center; cursor:pointer; }
    .logo{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent),var(--accent-3)); color:white; font-weight:800; }
    .title{ font-weight:700; color:var(--accent); font-size:1.15rem; }
    .search-input{ padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.08); width:320px; outline:none; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    .navlinks{ display:flex; gap:8px; align-items:center; }
    .nav-btn{ background:transparent; border:0; padding:8px 10px; cursor:pointer; border-radius:8px; }
    .nav-btn.active{ background:rgba(30,136,229,0.08); color:var(--accent); }
    .btn-primary{ background:linear-gradient(90deg,var(--accent),#1565c0); color:white; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:700; }
    .btn-ghost{ background:transparent; border:1px solid rgba(0,0,0,0.08); padding:10px 12px; border-radius:10px; cursor:pointer; }
    .wrap{ max-width:1200px; margin:28px auto; padding:0 20px; }
    .card{ background:white; border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.03); margin-bottom:20px; }
    .product-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:18px; margin-top:16px; }
    .product-card{ border-radius:12px; overflow:hidden; transition:transform .18s ease,box-shadow .18s ease; border:1px solid rgba(0,0,0,0.04); background:white; }
    .product-card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.07); }
    .product-image{ width:100%; height:160px; display:flex; align-items:center; justify-content:center; background:#f5f5f5; object-fit:cover; }
    .product-info{ padding:12px; }
    .price{ color:var(--accent-2); font-weight:800; font-size:1.05rem; }
    .small{ font-size:0.9rem; color:var(--muted); }
    .muted{ color:var(--muted); }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:700; font-size:0.75rem; margin-left:6px; }
    .badge-info{ background:rgba(30,136,229,0.1); color:var(--accent); }
    .badge-success{ background:rgba(67,160,71,0.1); color:var(--success); }
    .toast{ position:fixed; right:20px; bottom:20px; z-index:9999; padding:12px 16px; background:white; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.12); display:none; }
    .tooltip-inline{ position:relative; cursor:help; }
    .tooltip-inline .tip{ position:absolute; bottom:120%; left:50%; transform:translateX(-50%); background:#333; color:white; padding:8px 10px; border-radius:8px; white-space:nowrap; display:none; font-size:0.85rem; }
    .tooltip-inline:hover .tip{ display:block; }

    /* Map specific */
    #mapContainer{ width:100%; height:420px; border-radius:12px; background:#eef2f6; overflow:hidden; }
    .map-info { margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .map-stats { font-weight:800; color:var(--accent); font-size:1.05rem; }

    /* responsive */
    @media(max-width:900px){ .search-input{ width:200px; } }
    @media(max-width:700px){ .map-info{ flex-direction:column; } .navlinks{ display:flex; flex-wrap:wrap; } }
  </style>

  <!-- Leaflet CSS (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand" onclick="document.getElementById('splash').scrollIntoView({behavior:'smooth'})">
      <div class="logo">SP</div>
      <div class="title">SmartPrice</div>
    </div>

    <div style="position:relative;">
      <input id="globalSearch" class="search-input" placeholder="Buscar productos (ej.: leche, huevo)..." autocomplete="off">
      <div id="suggestions" class="suggestions" style="display:none; position: absolute; top:44px; left:0;"></div>
    </div>

    <div class="navlinks" id="topNav">
      <button onclick="navigate('splash')" class="nav-btn">üè† Inicio</button>
      <button onclick="navigate('home')" class="nav-btn">üõçÔ∏è Productos</button>
      <button onclick="navigate('search')" class="nav-btn">üîç Buscar</button>
      <button onclick="navigate('compare')" class="nav-btn">üìä Comparar</button>
      <button onclick="navigate('map')" class="nav-btn">üó∫Ô∏è Mapa</button>
      <button onclick="navigate('cart')" class="nav-btn">üõí Carrito <span id="badgeCart" class="badge badge-info">0</span></button>
      <button onclick="navigate('profile')" class="nav-btn">üë§ Perfil</button>
      <button class="btn-primary" onclick="navigate('chat')">üí¨ Chat</button>
    </div>
  </header>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <!-- SPLASH -->
    <section id="splash" class="card">
      <div style="display:flex; gap:18px; align-items:center; justify-content:space-between;">
        <div style="flex:1;">
          <h1 style="margin:0">SmartPrice ‚Äî Tu compra inteligente</h1>
          <p class="small muted" style="margin-top:8px;">Compara precios en tiempo real, recibe alertas personalizadas y ahorra en tu compra semanal.</p>
          <div style="margin-top:12px;"><button class="btn-primary" onclick="navigate('home')">Explorar productos</button></div>
        </div>
        <div style="width:320px;">
          <img src="https://i.ibb.co/0RhB3WCm/logo-y-nombre-redimensionado-removebg-preview.png" alt="SmartPrice Demo" style="width:100%; height:140px; object-fit:contain;">
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section id="home" class="card">
      <h2>Productos destacados</h2>
      <div class="small muted">Precios actualizados ‚Ä¢ Integraci√≥n demo</div>
      <div id="productsGrid" class="product-grid" style="margin-top:16px;"></div>
    </section>

    <!-- SEARCH -->
    <section id="search" class="card">
      <h2>Buscar productos</h2>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <select id="catFilter" style="padding:8px; border-radius:8px;"></select>
        <select id="storeFilter" style="padding:8px; border-radius:8px;"></select>
        <input id="searchBox" class="search-input" placeholder="Buscar..." onkeydown="if(event.key==='Enter') doSearch()">
        <button class="btn-primary" onclick="doSearch()">Buscar</button>
      </div>
      <div id="searchResults" style="margin-top:12px;"></div>
    </section>

    <!-- COMPARE -->
    <section id="compare" class="card">
      <h2>Comparar precios por tienda</h2>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <select id="compareProduct" style="padding:8px; border-radius:8px;"></select>
        <select id="compareMode" style="padding:8px; border-radius:8px;">
          <option value="price">Mejor Precio</option>
          <option value="distance">M√°s Cercano</option>
          <option value="balance">Balance</option>
        </select>
        <button class="btn-primary" onclick="doCompare()">Comparar</button>
        <button class="btn-ghost" onclick="exportCompareCSV()">Exportar CSV</button>
      </div>
      <div id="compareResult" style="margin-top:12px;"></div>
    </section>

    <!-- PRODUCT DETAIL -->
    <section id="product" class="card">
      <h2>Detalle de producto</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1 1 320px;">
          <div id="detailImage" class="product-image"></div>
        </div>
        <div style="flex:2 1 420px;">
          <div id="detailTitle" style="font-weight:800; font-size:1.1rem;"></div>
          <div id="detailCategory" class="small muted"></div>
          <div id="detailPrice" class="price" style="margin-top:8px;"></div>
          <p id="detailDesc" class="small muted" style="margin-top:8px;"></p>
          <div style="margin-top:12px;">
            <button class="btn-primary" id="btnAddDetail">A√±adir al carrito</button>
            <button class="btn-ghost" id="btnFollowDetail">Seguir producto</button>
          </div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <h4>Precios en tiendas</h4>
        <div id="storesCompare" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- CART -->
    <section id="cart" class="card">
      <h2>Carrito</h2>
      <div id="cartItems"></div>
      <div style="margin-top:12px;">
        <div>Subtotal: <span id="cartSubtotal">$0.00</span></div>
        <div>Ahorro estimado: <span id="cartSaving">$0.00</span></div>
        <div>Total: <strong id="cartTotal">$0.00</strong></div>
      </div>
      <div style="margin-top:10px;"><button class="btn-primary" onclick="checkout()">Generar plan de compra</button></div>
    </section>

    <!-- MAP (AQU√ç va el mapa; secci√≥n visible por scroll) -->
    <section id="map" class="card">
      <h2>Mapa de tiendas</h2>
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
        <button class="btn-ghost" onclick="filterMap('open')">üïí Abierto ahora</button>
        <button class="btn-ghost" onclick="filterMap('delivery')">üöö Env√≠o</button>
        <button class="btn-primary" onclick="useMyLocation()">üìç Usar mi ubicaci√≥n</button>
        <div class="right small muted" id="mapStatus" style="margin-left:auto;">Ubicaci√≥n: demo</div>
      </div>

      <div id="mapContainer"></div>

      <div class="map-info" style="margin-top:12px;">
        <div class="card" style="flex:1; min-width:220px;">
          <div class="small muted">Tienda objetivo</div>
          <div id="mapTargetName" class="map-stats">‚Äî</div>
          <div class="small muted">Distancia (l√≠nea recta)</div>
          <div id="mapDistance" class="small muted">‚Äî</div>
        </div>
        <div class="card" style="flex:1; min-width:220px;">
          <div class="small muted">Tiempo estimado (a 40 km/h)</div>
          <div id="mapETA" class="map-stats">‚Äî</div>
          <div style="margin-top:8px;" class="small muted">Velocidad usada: 40 km/h</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h4>Lista de tiendas</h4>
        <div id="storeList"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="card">
      <h2>Mi perfil</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1;">
          <div id="profileName" style="font-weight:800;">Invitado</div>
          <div id="profileEmail" class="small muted">invitado@demo</div>
        </div>
        <div style="flex:1;">
          <label class="small muted">Nombre</label>
          <input id="profileInputName" style="width:100%; padding:8px; border-radius:8px;">
          <label class="small muted" style="margin-top:8px; display:block;">Correo</label>
          <input id="profileInputEmail" style="width:100%; padding:8px; border-radius:8px;">
          <div style="margin-top:8px;">
            <button class="btn-primary" onclick="saveProfile()">Guardar</button>
            <button class="btn-ghost" onclick="logout()">Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>
      <div style="margin-top:12px;"><h4>Preferencias</h4>
        <div>Radio de b√∫squeda: <input id="searchRadius" type="range" min="1" max="20" value="5"> <span id="radiusValue">5 km</span></div>
      </div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="card">
      <h2>Asistente Virtual SmartPrice</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1 1 680px;">
          <div id="chatWindow" style="height:260px; overflow:auto; padding:12px; border-radius:10px; background:#fafafa;"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="chatInput" style="flex:1; padding:8px; border-radius:8px;" placeholder='Ej: "¬øD√≥nde est√° m√°s barata la leche?"' onkeydown="if(event.key==='Enter') sendChat()'>
            <button class="btn-primary" onclick="sendChat()">Enviar</button>
          </div>
        </div>
        <div style="width:320px;">
          <div class="small muted">1,250 productos validados ‚Ä¢ Actualizado: demo</div>
        </div>
      </div>
    </section>

    <footer style="text-align:center; padding:18px; color:var(--muted);">¬© 2025 SmartPrice ‚Äî Mockup interactivo ‚Ä¢ Demo local</footer>
  </div>

  <!-- MODAL BACKDROP (simple) -->
  <div id="modalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div id="modalContent" style="background:white; padding:18px; border-radius:12px; max-width:680px;"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SCRIPT: l√≥gica completa (productos, carrito, mapa, etc.) -->
  <script>
    /***********************
     * Datos demo
     ***********************/
    const PRODUCTS = [
      { id:1, name:'Leche Alpura 1L', category:'L√°cteos', image:'https://lacentraldeabastos.com/wp-content/uploads/2024/10/photoroom_006_20241014_154037-1.jpg', description:'Leche entera pasteurizada 1L', pricePerUnit:23.5, trend:'down', validation:true, offerLevel:'high',
        stores:[ {name:'Walmart Altabrisa', price:23.5, distance:1.2, time:15}, {name:'Soriana Montejo', price:24.3, distance:2.1, time:25}, {name:'Chedraui Itzaes', price:22.9, distance:3.5, time:35} ]
      },
      { id:2, name:'Huevo Blanco 30pz', category:'Abarrotes', image:'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60', description:'Paquete de 30 huevos', pricePerUnit:68.5, trend:'stable', validation:true, offerLevel:'medium',
        stores:[ {name:'Walmart Altabrisa', price:68.5, distance:1.2, time:15}, {name:'Soriana Montejo', price:65.9, distance:2.1, time:25}, {name:'Chedraui Itzaes', price:70.2, distance:3.5, time:35} ]
      },
      { id:3, name:'Frijol Negro 1kg', category:'Legumbres', image:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTSVYdquQdFsNzjTRoP--mEb9Lr2-gp2-4TkA&s', description:'Frijol negro 1kg', pricePerUnit:38.0, trend:'up', validation:false, offerLevel:'high',
        stores:[ {name:'Walmart Altabrisa', price:38.0, distance:1.2, time:15}, {name:'Soriana Montejo', price:35.5, distance:2.1, time:25}, {name:'Chedraui Itzaes', price:36.8, distance:3.5, time:35} ]
      }
    ];

    const STORES = [
      { name:'Walmart Altabrisa', avg:'$$', hours:'8:00 - 22:00', traffic:'Poca afluencia', services:['Estacionamiento','Delivery','Recogida'] },
      { name:'Soriana Montejo', avg:'$$', hours:'7:00 - 23:00', traffic:'Afluencia media', services:['Estacionamiento','Delivery'] },
      { name:'Chedraui Itzaes', avg:'$', hours:'8:00 - 22:00', traffic:'Mucha afluencia', services:['Estacionamiento','Recogida'] }
    ];

    const STORE_COORDS = {
      "Walmart Altabrisa": { lat:21.022300, lng:-89.586800 },
      "Soriana Montejo":     { lat:20.990600, lng:-89.627100 },
      "Chedraui Itzaes":     { lat:20.969100, lng:-89.641200 }
    };

    /***********************
     * Estado y persistencia
     ***********************/
    const state = {
      cart: JSON.parse(localStorage.getItem('sp_cart') || '[]'),
      favorites: JSON.parse(localStorage.getItem('sp_favs') || '[]'),
      profile: JSON.parse(localStorage.getItem('sp_profile') || 'null') || { name:'Invitado', email:'invitado@demo' },
      savedSearches: JSON.parse(localStorage.getItem('sp_savedSearches') || '[]'),
      savedLists: JSON.parse(localStorage.getItem('sp_savedLists') || '[]'),
      chatHistory: JSON.parse(localStorage.getItem('sp_chat') || '[]'),
      viewMode: localStorage.getItem('sp_view') || 'compact'
    };

    /***********************
     * UI init
     ***********************/
    document.addEventListener('DOMContentLoaded', () => {
      populateFilters();
      renderProducts();
      renderCart();
      renderProfile();
      renderStoresList();
      renderCompareSelector();
      restoreChat();
      setupSearchAutocomplete();
      updateBadge();
      applyViewMode();
      document.getElementById('searchRadius').addEventListener('input', (e)=> {
        document.getElementById('radiusValue').innerText = e.target.value + ' km';
      });

      // Inicializar mapa (la secci√≥n #map es visible por scroll)
      initLeafletMap();
    });

    /***********************
     * Navegaci√≥n: SCROLL a secciones (p√°gina larga)
     ***********************/
    function navigate(sectionId){
      const el = document.getElementById(sectionId);
      if(!el) return;
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // marcar boton activo visualmente
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const btn = [...document.querySelectorAll('.nav-btn')].find(b => b.textContent.toLowerCase().includes(el.id==='home' ? 'productos' : el.id));
      if(btn) btn.classList.add('active');
    }

    /***********************
     * Productos
     ***********************/
    function renderProducts(filterText=''){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      const q = (filterText || '').toLowerCase();
      const items = PRODUCTS.filter(p => !q || p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q));
      items.forEach(p => {
        const card = document.createElement('div'); card.className = 'product-card card';
        const img = document.createElement('div'); img.className='product-image'; img.style.backgroundImage = `url(${p.image})`; img.style.backgroundSize='cover';
        const info = document.createElement('div'); info.className='product-info';
        info.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>${p.name}</strong><div class="small muted">${p.category}</div></div><button class="btn-ghost">${state.favorites.includes(p.id)?'üíñ Favorito':'‚ô° Favorito'}</button></div>
                          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;"><div class="price">$${p.pricePerUnit.toFixed(2)}</div><div><button class="btn-primary" onclick="openProduct(${p.id})">Ver</button> <button class="btn-ghost" onclick="addToCart(${p.id})">A√±adir</button></div></div>`;
        card.appendChild(img); card.appendChild(info); grid.appendChild(card);
      });
    }

    /***********************
     * Favoritos, carrito y UI helpers
     ***********************/
    function toggleFavorite(id){ const idx = state.favorites.indexOf(id); if(idx===-1) state.favorites.push(id); else state.favorites.splice(idx,1); localStorage.setItem('sp_favs', JSON.stringify(state.favorites)); renderProducts(); renderFollowed(); updateBadge(); }
    function renderFollowed(){ const c = document.getElementById('storeList'); /* kept simple */ }

    function addToCart(productId, qty=1){
      const item = state.cart.find(i=>i.id===productId);
      if(item) item.qty += qty; else state.cart.push({ id:productId, qty });
      localStorage.setItem('sp_cart', JSON.stringify(state.cart));
      renderCart(); updateBadge(); showToast('Producto a√±adido al carrito',1400);
    }
    function renderCart(){
      const container = document.getElementById('cartItems');
      container.innerHTML = '';
      if(state.cart.length===0){ container.innerHTML = '<div class="small muted">No hay art√≠culos en el carrito</div>'; updateTotals(); return; }
      state.cart.forEach(ci => {
        const p = PRODUCTS.find(x=>x.id===ci.id);
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
        row.innerHTML = `<div><strong>${p.name}</strong><div class="small muted">${p.category}</div></div><div><strong>$${(p.pricePerUnit*ci.qty).toFixed(2)}</strong><div style="margin-top:6px;"><button class="btn-ghost" onclick="changeQty(${p.id},-1)">-</button> ${ci.qty} <button class="btn-ghost" onclick="changeQty(${p.id},1)">+</button></div></div>`;
        container.appendChild(row);
      });
      updateTotals();
    }
    function changeQty(id,delta){ const it = state.cart.find(x=>x.id===id); if(!it)return; it.qty+=delta; if(it.qty<=0) state.cart = state.cart.filter(x=>x.id!==id); localStorage.setItem('sp_cart', JSON.stringify(state.cart)); renderCart(); updateBadge(); }
    function updateTotals(){ const subtotal = state.cart.reduce((s,it)=>{ const p=PRODUCTS.find(x=>x.id===it.id); return s + (p? p.pricePerUnit*it.qty:0); },0); const saving = subtotal*0.05; document.getElementById('cartSubtotal').innerText=`$${subtotal.toFixed(2)}`; document.getElementById('cartSaving').innerText=`$${saving.toFixed(2)}`; document.getElementById('cartTotal').innerText=`$${(subtotal-saving).toFixed(2)}`; document.getElementById('badgeCart').innerText=state.cart.reduce((a,b)=>a+b.qty,0); }
    function checkout(){ if(state.cart.length===0){ showToast('Tu carrito est√° vac√≠o',1400); return; } openModal('Plan', `<pre>${JSON.stringify(state.cart,null,2)}</pre><div style="text-align:right;margin-top:8px;"><button class="btn-primary" onclick="closeModal()">Cerrar</button></div>`); }

    /***********************
     * Detalle producto
     ***********************/
    function openProduct(id){
      const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
      document.getElementById('detailImage').style.backgroundImage = `url(${p.image})`;
      document.getElementById('detailTitle').innerText = p.name;
      document.getElementById('detailCategory').innerText = p.category;
      document.getElementById('detailPrice').innerText = `$${p.pricePerUnit.toFixed(2)}`;
      document.getElementById('detailDesc').innerText = p.description;
      document.getElementById('btnAddDetail').onclick = ()=> addToCart(p.id);
      document.getElementById('btnFollowDetail').onclick = ()=> toggleFavorite(p.id);
      navigate('product');
      renderProductStores(p);
    }
    function renderProductStores(p){
      const container = document.getElementById('storesCompare'); container.innerHTML='';
      p.stores.forEach(s=>{ const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='8px 0'; el.innerHTML = `<div><strong>${s.name}</strong><div class="small muted">${s.distance} km ‚Ä¢ ${s.time} min</div></div><div><strong style="color:var(--accent-2)">$${s.price.toFixed(2)}</strong></div>`; container.appendChild(el); });
    }

    /***********************
     * Search & suggestions
     ***********************/
    function populateFilters(){
      const cats = [...new Set(PRODUCTS.map(p=>p.category))];
      const catSelect = document.getElementById('catFilter'); cats.forEach(c=>catSelect.appendChild(new Option(c,c)));
      const storeSelect = document.getElementById('storeFilter'); const storeNames=[...new Set(PRODUCTS.flatMap(p=>p.stores.map(s=>s.name)))]; storeNames.forEach(s=>storeSelect.appendChild(new Option(s,s)));
    }
    function setupSearchAutocomplete(){
      const input=document.getElementById('globalSearch'); const suggestions=document.getElementById('suggestions');
      input.addEventListener('input', e=>{ const q=e.target.value.trim().toLowerCase(); if(!q){ suggestions.style.display='none'; return;} const matches=PRODUCTS.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q)).slice(0,6); suggestions.innerHTML=matches.map(m=>`<div style="padding:8px;cursor:pointer;" data-id="${m.id}"><strong>${m.name}</strong><div class="small muted">${m.category}</div></div>`).join(''); suggestions.style.display=matches.length?'block':'none'; });
      suggestions.addEventListener('click', e=>{ const item=e.target.closest('[data-id]'); if(!item) return; openProduct(Number(item.dataset.id)); suggestions.style.display='none'; input.value=''; });
    }
    function doSearch(){
      const q=document.getElementById('searchBox').value.trim().toLowerCase(); if(!q){ showToast('Ingrese texto para buscar',1200); return; }
      const c=document.getElementById('catFilter').value; const s=document.getElementById('storeFilter').value;
      let filtered = PRODUCTS.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q));
      filtered = filtered.filter(p => (!c||p.category===c) && (!s||p.stores.some(st=>st.name===s)));
      const container=document.getElementById('searchResults'); container.innerHTML='';
      if(filtered.length===0){ container.innerHTML='<div class="small muted">No se encontraron resultados</div>'; return; }
      filtered.forEach(p => { const el=document.createElement('div'); el.className='card'; el.style.marginBottom='8px'; el.innerHTML = `<div style="display:flex;justify-content:space-between;"><div><strong>${p.name}</strong><div class="small muted">${p.category}</div></div><div><strong style="color:var(--accent-2)">$${p.pricePerUnit.toFixed(2)}</strong><div style="margin-top:6px;"><button class="btn-ghost" onclick="openProduct(${p.id})">Ver</button></div></div></div>`; container.appendChild(el); });
    }

    /***********************
     * Perfil y chat
     ***********************/
    function saveProfile(){ const name=document.getElementById('profileInputName').value.trim()||'Invitado'; const email=document.getElementById('profileInputEmail').value.trim()||'invitado@demo'; state.profile={name,email}; localStorage.setItem('sp_profile', JSON.stringify(state.profile)); renderProfile(); showToast('Perfil guardado',1200); }
    function renderProfile(){ document.getElementById('profileName').innerText = state.profile.name; document.getElementById('profileEmail').innerText = state.profile.email; document.getElementById('profileInputName').value=state.profile.name; document.getElementById('profileInputEmail').value=state.profile.email; }
    function logout(){ if(confirm('¬øCerrar sesi√≥n?')){ localStorage.removeItem('sp_profile'); state.profile={name:'Invitado',email:'invitado@demo'}; renderProfile(); showToast('Sesi√≥n cerrada',1200); } }

    function restoreChat(){ const win=document.getElementById('chatWindow'); win.innerHTML=''; if(state.chatHistory.length===0){ win.appendChild(createBubble('bot','¬°Hola! Soy tu asistente de compras.')); } else state.chatHistory.forEach(m => win.appendChild(createBubble(m.role,m.text))); win.scrollTop=win.scrollHeight; }
    function createBubble(role,text){ const b=document.createElement('div'); b.style.marginBottom='8px'; b.innerHTML = `<div style="max-width:80%; padding:10px; border-radius:10px; ${role==='bot'?'background:#f1f3f5;color:var(--text)':'background:linear-gradient(90deg,var(--accent),#1565c0);color:white;align-self:flex-end;'}"><strong>${role==='bot'?'SmartPrice':'T√∫'}:</strong> ${text}</div>`; return b; }
    function sendChat(){ const input=document.getElementById('chatInput'); const text=input.value.trim(); if(!text) return; state.chatHistory.push({role:'user',text}); localStorage.setItem('sp_chat', JSON.stringify(state.chatHistory)); const win=document.getElementById('chatWindow'); win.appendChild(createBubble('user',text)); input.value=''; setTimeout(()=>{ const ans = generateChatAnswer(text); state.chatHistory.push({role:'bot',text:ans}); localStorage.setItem('sp_chat', JSON.stringify(state.chatHistory)); win.appendChild(createBubble('bot',ans)); win.scrollTop=win.scrollHeight; },500); }
    function generateChatAnswer(t){ const q=t.toLowerCase(); if(q.includes('leche')) return 'La leche Alpura 1L est√° desde $22.90 en Chedraui Itzaes (demo).'; if(q.includes('ofertas')) return 'Hay ofertas en l√°cteos y abarrotes.'; return 'Puedo comparar precios, guardar alertas o generar un plan de compra.'; }

    /***********************
     * Modales y utilidades
     ***********************/
    function showToast(msg, ms=1600){ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; clearTimeout(t._timeout); t._timeout=setTimeout(()=>t.style.display='none', ms); }
    function openModal(title, html){ const backdrop=document.getElementById('modalBackdrop'); const content=document.getElementById('modalContent'); content.innerHTML = `<h3>${title}</h3><div>${html}</div>`; backdrop.style.display='flex'; }
    function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; }

    /***********************
     * Map: Leaflet (inicializaci√≥n segura para p√°gina con scroll)
     ***********************/
    let leafletMap = null;
    let leafletUserMarker = null;
    let currentLine = null;
    let leafletMarkers = [];

    function initLeafletMap(){
      // Verificar existencia del contenedor
      const mapEl = document.getElementById('mapContainer');
      if(!mapEl) return;
      try {
        leafletMap = L.map(mapEl).setView([20.9674, -89.5926], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(leafletMap);

        // Marcadores de tiendas
        Object.keys(STORE_COORDS).forEach(name => {
          const c = STORE_COORDS[name];
          const m = L.marker([c.lat, c.lng]).addTo(leafletMap);
          m.bindPopup(`<strong>${name}</strong><br><div class="small muted">Clic: trazar ruta recta</div><div style="margin-top:8px;"><button class="btn-ghost" onclick="traceToStore('${name}')">Trazar ruta</button></div>`);
          leafletMarkers.push({ name, marker: m });
        });

        // Llenar lista lateral de tiendas
        renderStoresList();

        // Si el usuario scrollea y el mapa se ajusta, forzar invalidateSize (corrige problemas de render)
        window.addEventListener('resize', ()=> { if(leafletMap) leafletMap.invalidateSize(); });
        // Tambi√©n al hacer scroll lento (por si cambian layout)
        document.addEventListener('scroll', () => { if(leafletMap) leafletMap.invalidateSize(); });

        showToast('Mapa inicializado', 1400);
      } catch(e){
        console.error('Error inicializando mapa', e);
        showToast('Error al inicializar mapa', 1600);
      }
    }

    function renderStoresList(){
      const listEl = document.getElementById('storeList');
      if(!listEl) return;
      listEl.innerHTML = '';
      STORES.forEach(s => {
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>${s.name}</strong><div class="small muted">${s.hours} ‚Ä¢ ${s.traffic}</div></div><div><button class="btn-primary" onclick="centerOnStore('${s.name}')">Ver</button></div></div>`;
        listEl.appendChild(div);
      });
    }

    function centerOnStore(name){
      const c = STORE_COORDS[name];
      if(!c || !leafletMap) return;
      leafletMap.setView([c.lat, c.lng], 14);
      const entry = leafletMarkers.find(x=>x.name===name);
      if(entry) entry.marker.openPopup();
    }

    function traceToStore(name){
      const c = STORE_COORDS[name];
      if(!c) { showToast('Coordenadas no disponibles',1400); return; }
      if(!leafletUserMarker){ showToast('Usa "üìç Usar mi ubicaci√≥n" primero',1600); return; }
      // remover l√≠nea previa
      if(currentLine){ leafletMap.removeLayer(currentLine); currentLine = null; }
      const userLatLng = leafletUserMarker.getLatLng();
      const storeLatLng = L.latLng(c.lat, c.lng);
      currentLine = L.polyline([userLatLng, storeLatLng], { color:'#1e88e5', weight:4, dashArray:'6,6' }).addTo(leafletMap);
      leafletMap.fitBounds(currentLine.getBounds(), { padding: [40,40] });

      const distKm = haversineDistance(userLatLng.lat, userLatLng.lng, c.lat, c.lng);
      const speedKmH = 40;
      const etaMin = Math.max(1, Math.round((distKm / speedKmH) * 60));

      document.getElementById('mapTargetName').innerText = name;
      document.getElementById('mapDistance').innerText = `${distKm.toFixed(2)} km`;
      document.getElementById('mapETA').innerText = `${etaMin} min`;

      showToast(`Ruta trazada: ${distKm.toFixed(2)} km (~${etaMin} min)`, 2000);
    }

    // Haversine
    function haversineDistance(lat1, lon1, lat2, lon2){
      const toRad = v => v * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function useMyLocation(){
      if(!navigator.geolocation){ showToast('Geolocalizaci√≥n no disponible',1400); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude; const lng = pos.coords.longitude;
        if(leafletUserMarker) leafletMap.removeLayer(leafletUserMarker);
        leafletUserMarker = L.marker([lat,lng], { icon: L.icon({ iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize:[32,32], iconAnchor:[16,32] }) }).addTo(leafletMap).bindPopup('üìç Est√°s aqu√≠').openPopup();
        leafletMap.setView([lat,lng], 13);
        document.getElementById('mapStatus').innerText = `Ubicaci√≥n: ${lat.toFixed(3)}, ${lng.toFixed(3)}`;
        // trazar la tienda m√°s cercana autom√°ticamente
        const nearest = findNearestByLine(lat,lng);
        if(nearest) traceToStore(nearest.name);
      }, err => {
        showToast('Permiso de ubicaci√≥n denegado o error',1600);
      }, { enableHighAccuracy:true, timeout:10000 });
    }

    function findNearestByLine(lat,lng){
      let minD = Infinity; let nearest = null;
      Object.keys(STORE_COORDS).forEach(name => {
        const c = STORE_COORDS[name];
        const d = haversineDistance(lat,lng,c.lat,c.lng);
        if(d < minD){ minD = d; nearest = { name, dist: d }; }
      });
      return nearest;
    }

    function filterMap(type){
      showToast('Aplicando filtro: ' + type, 1200);
      leafletMarkers.forEach(item => {
        const st = STORES.find(s=>s.name===item.name);
        if(!st) return;
        if(type==='delivery' && !st.services.includes('Delivery')) leafletMap.removeLayer(item.marker);
        else item.marker.addTo(leafletMap);
      });
    }

    /***********************
     * Utils
     ***********************/
    function renderCompareSelector(){ const sel=document.getElementById('compareProduct'); if(!sel) return; sel.innerHTML = PRODUCTS.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
    function doCompare(){ /* simplified earlier logic */ const pid=Number(document.getElementById('compareProduct').value); const p=PRODUCTS.find(x=>x.id===pid); if(!p) return; const container=document.getElementById('compareResult'); container.innerHTML = `<div><strong>${p.name}</strong></div>`; }
    function exportCompareCSV(){ showToast('CSV export (demo)',1200); }
    function renderStoresList(){ /* already implemented above */ }

    function updateBadge(){ document.getElementById('badgeCart').innerText = state.cart.reduce((a,b)=>a+b.qty,0); }

    // Inicial render helpers
    function restoreEverything(){ renderProducts(); renderCart(); renderProfile(); renderStoresList(); renderCompareSelector(); renderFollowed(); showPriceAlertsDemo(); }
    function showPriceAlertsDemo(){ const container = document.getElementById('storeList'); /* demo placeholder */ }
    restoreEverything();

    // Exponer modal cerrador
    window.closeModal = closeModal;

  </script>
</body>
</html>
