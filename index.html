# Creating enhanced SmartPrice code with all use cases

# Create the enhanced HTML with all use cases implemented
enhanced_code = '''<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartPrice ‚Äî Tu compra inteligente</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet para mapas (CU-004: Rutas optimizadas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Estilos -->
  <style>
    :root{
      --bg: #f8fafc;
      --glass: rgba(255,255,255,0.8);
      --panel: #ffffff;
      --accent: #1e88e5;
      --accent-2: #ff6d00;
      --accent-3: #5e35b1;
      --success: #43a047;
      --muted: #546e7a;
      --card: linear-gradient(180deg, #ffffff, #fafafa);
      --radius: 16px;
      --glass-2: rgba(255,255,255,0.9);
      --text: #333333;
      --text-light: #78909c;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --shadow-hover: 0 15px 40px rgba(0,0,0,0.12);
      color-scheme: light;
    }
    *{ box-sizing: border-box; }
    html,body{ 
      height:100%; margin:0; 
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(180deg,#f8fafc 0%, #e3f2fd 100%); 
      color:var(--text); 
      -webkit-font-smoothing:antialiased; 
      -moz-osx-font-smoothing:grayscale; 
      font-size: 16px; 
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:1200;
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 24px; gap:16px;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.85);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .brand{ display:flex; gap:12px; align-items:center; cursor:pointer; }
    .brand .logo{
      background: linear-gradient(135deg,var(--accent),var(--accent-3));
      width:48px; height:48px; border-radius:12px; 
      display:flex; align-items:center; justify-content:center;
      font-size:24px; font-weight:800; color:#fff;
    }
    .brand .title{ font-size:22px; font-weight:700; color:var(--text); }
    
    .nav-icons{ display:flex; gap:12px; align-items:center; }
    .nav-icons .icon-btn{
      position:relative;
      width:44px; height:44px; border-radius:12px;
      background:var(--glass); border:1px solid rgba(0,0,0,0.06);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all 0.3s;
      font-size:20px;
    }
    .nav-icons .icon-btn:hover{
      background:#fff; transform:translateY(-2px);
      box-shadow:var(--shadow);
    }
    .nav-icons .icon-btn .badge{
      position:absolute; top:-4px; right:-4px;
      background:var(--accent-2); color:#fff;
      border-radius:10px; padding:2px 6px;
      font-size:11px; font-weight:600;
    }

    /* Main Container */
    .main-container{
      max-width:1400px; margin:0 auto; padding:32px 24px;
    }

    /* Search Bar */
    .search-section{
      background:var(--glass-2);
      backdrop-filter:blur(16px);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      margin-bottom:32px;
    }
    .search-box{
      display:flex; gap:12px; margin-bottom:20px;
    }
    .search-box input{
      flex:1; padding:16px 20px;
      border:2px solid rgba(0,0,0,0.08);
      border-radius:12px; font-size:16px;
      font-family:'Poppins',sans-serif;
      transition:all 0.3s;
    }
    .search-box input:focus{
      outline:none; border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(30,136,229,0.1);
    }
    .search-box button{
      padding:16px 32px; border:none;
      background:linear-gradient(135deg,var(--accent),var(--accent-3));
      color:#fff; border-radius:12px;
      font-weight:600; font-size:16px;
      cursor:pointer; transition:all 0.3s;
      font-family:'Poppins',sans-serif;
    }
    .search-box button:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-hover);
    }

    /* Filters */
    .filters{
      display:flex; gap:12px; flex-wrap:wrap;
    }
    .filter-btn{
      padding:10px 20px; border:2px solid rgba(0,0,0,0.08);
      background:#fff; border-radius:20px;
      font-size:14px; font-weight:500;
      cursor:pointer; transition:all 0.3s;
      font-family:'Poppins',sans-serif;
    }
    .filter-btn:hover, .filter-btn.active{
      border-color:var(--accent);
      background:rgba(30,136,229,0.1);
      color:var(--accent);
    }

    /* Results Grid */
    .results-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:24px;
      margin-bottom:32px;
    }
    .product-card{
      background:var(--glass-2);
      backdrop-filter:blur(16px);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
      transition:all 0.3s;
      cursor:pointer;
      position:relative;
    }
    .product-card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-hover);
    }
    .product-card .product-image{
      width:100%; height:200px;
      background:#f0f0f0;
      border-radius:12px;
      margin-bottom:16px;
      display:flex; align-items:center; justify-content:center;
      font-size:64px;
    }
    .product-card .product-name{
      font-size:18px; font-weight:600;
      margin-bottom:8px; color:var(--text);
    }
    .product-card .product-store{
      font-size:14px; color:var(--text-light);
      margin-bottom:12px;
    }
    .product-card .product-price{
      font-size:28px; font-weight:700;
      color:var(--accent); margin-bottom:12px;
    }
    .product-card .product-availability{
      display:inline-block;
      padding:6px 12px; border-radius:20px;
      font-size:12px; font-weight:600;
      margin-bottom:12px;
    }
    .product-card .product-availability.available{
      background:rgba(67,160,71,0.1);
      color:var(--success);
    }
    .product-card .product-availability.limited{
      background:rgba(255,109,0,0.1);
      color:var(--accent-2);
    }
    .product-card .product-availability.unavailable{
      background:rgba(0,0,0,0.05);
      color:var(--muted);
    }
    .product-card .product-actions{
      display:flex; gap:8px; margin-top:16px;
    }
    .product-card .btn-action{
      flex:1; padding:10px;
      border:none; border-radius:8px;
      font-size:14px; font-weight:600;
      cursor:pointer; transition:all 0.3s;
      font-family:'Poppins',sans-serif;
    }
    .btn-primary{
      background:var(--accent); color:#fff;
    }
    .btn-primary:hover{
      background:var(--accent-3);
    }
    .btn-secondary{
      background:rgba(0,0,0,0.05); color:var(--text);
    }
    .btn-secondary:hover{
      background:rgba(0,0,0,0.1);
    }
    .product-card .report-btn{
      position:absolute; top:16px; right:16px;
      width:32px; height:32px;
      background:rgba(255,255,255,0.9);
      border:none; border-radius:8px;
      cursor:pointer; font-size:16px;
      transition:all 0.3s;
    }
    .product-card .report-btn:hover{
      background:var(--accent-2);
      color:#fff;
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:2000;
      align-items:center; justify-content:center;
      backdrop-filter:blur(4px);
    }
    .modal.active{ display:flex; }
    .modal-content{
      background:#fff;
      border-radius:var(--radius);
      padding:32px;
      max-width:600px;
      width:90%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header{
      display:flex; justify-content:space-between;
      align-items:center; margin-bottom:24px;
    }
    .modal-header h2{
      margin:0; font-size:24px; font-weight:700;
    }
    .modal-close{
      width:36px; height:36px;
      border:none; background:rgba(0,0,0,0.05);
      border-radius:8px; cursor:pointer;
      font-size:20px; transition:all 0.3s;
    }
    .modal-close:hover{
      background:rgba(0,0,0,0.1);
    }
    .modal-body{
      margin-bottom:24px;
    }
    .form-group{
      margin-bottom:20px;
    }
    .form-group label{
      display:block; margin-bottom:8px;
      font-weight:600; font-size:14px;
    }
    .form-group input, .form-group select, .form-group textarea{
      width:100%; padding:12px 16px;
      border:2px solid rgba(0,0,0,0.08);
      border-radius:8px; font-size:14px;
      font-family:'Poppins',sans-serif;
      transition:all 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
      outline:none; border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(30,136,229,0.1);
    }
    .form-group textarea{
      resize:vertical; min-height:100px;
    }
    .file-upload{
      border:2px dashed rgba(0,0,0,0.2);
      border-radius:8px; padding:24px;
      text-align:center; cursor:pointer;
      transition:all 0.3s;
    }
    .file-upload:hover{
      border-color:var(--accent);
      background:rgba(30,136,229,0.05);
    }
    .file-upload input{
      display:none;
    }

    /* Chart Container */
    .chart-container{
      background:#fff;
      border-radius:12px;
      padding:20px;
      margin-bottom:20px;
      box-shadow:var(--shadow);
    }
    .chart-container canvas{
      max-width:100%;
    }

    /* Map Container */
    #map{
      height:400px;
      border-radius:12px;
      margin-bottom:20px;
    }

    /* Nutrition Info */
    .nutrition-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:16px;
      margin-top:20px;
    }
    .nutrition-item{
      background:rgba(0,0,0,0.02);
      padding:16px;
      border-radius:8px;
      text-align:center;
    }
    .nutrition-item .value{
      font-size:24px;
      font-weight:700;
      color:var(--accent);
    }
    .nutrition-item .label{
      font-size:12px;
      color:var(--text-light);
      margin-top:4px;
    }

    /* Recommendations */
    .recommendations-section{
      background:var(--glass-2);
      backdrop-filter:blur(16px);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:32px;
    }
    .recommendations-section h3{
      margin:0 0 20px 0;
      font-size:20px;
      font-weight:700;
    }
    .recommendation-card{
      background:#fff;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
    }
    .recommendation-card .icon{
      width:48px;
      height:48px;
      background:linear-gradient(135deg,var(--accent),var(--accent-3));
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      color:#fff;
    }
    .recommendation-card .content{
      flex:1;
    }
    .recommendation-card .title{
      font-weight:600;
      margin-bottom:4px;
    }
    .recommendation-card .description{
      font-size:14px;
      color:var(--text-light);
    }

    /* Shopping List */
    .shopping-list{
      background:var(--glass-2);
      backdrop-filter:blur(16px);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:32px;
    }
    .shopping-list h3{
      margin:0 0 20px 0;
      font-size:20px;
      font-weight:700;
    }
    .list-item{
      background:#fff;
      border-radius:8px;
      padding:12px 16px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .list-item .item-info{
      flex:1;
    }
    .list-item .item-name{
      font-weight:600;
    }
    .list-item .item-price{
      color:var(--accent);
      font-weight:700;
    }
    .list-item .item-actions{
      display:flex;
      gap:8px;
    }
    .list-item button{
      padding:6px 12px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      transition:all 0.3s;
    }
    .list-total{
      margin-top:20px;
      padding-top:20px;
      border-top:2px solid rgba(0,0,0,0.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .list-total .total-label{
      font-size:18px;
      font-weight:700;
    }
    .list-total .total-amount{
      font-size:28px;
      font-weight:700;
      color:var(--accent);
    }
    .savings-badge{
      background:rgba(67,160,71,0.1);
      color:var(--success);
      padding:8px 16px;
      border-radius:20px;
      font-size:14px;
      font-weight:600;
      margin-top:12px;
      display:inline-block;
    }

    /* Notifications Panel */
    .notifications-panel{
      position:fixed;
      top:80px;
      right:24px;
      width:360px;
      max-height:500px;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow-hover);
      display:none;
      flex-direction:column;
      z-index:1500;
    }
    .notifications-panel.active{
      display:flex;
    }
    .notifications-header{
      padding:20px;
      border-bottom:1px solid rgba(0,0,0,0.1);
      font-weight:700;
      font-size:18px;
    }
    .notifications-list{
      flex:1;
      overflow-y:auto;
      padding:12px;
    }
    .notification-item{
      background:rgba(0,0,0,0.02);
      border-radius:8px;
      padding:12px;
      margin-bottom:8px;
      cursor:pointer;
      transition:all 0.3s;
    }
    .notification-item:hover{
      background:rgba(30,136,229,0.1);
    }
    .notification-item.unread{
      background:rgba(30,136,229,0.15);
      border-left:4px solid var(--accent);
    }
    .notification-item .notif-title{
      font-weight:600;
      margin-bottom:4px;
    }
    .notification-item .notif-message{
      font-size:14px;
      color:var(--text-light);
      margin-bottom:4px;
    }
    .notification-item .notif-time{
      font-size:12px;
      color:var(--muted);
    }

    /* User Profile */
    .profile-section{
      background:var(--glass-2);
      backdrop-filter:blur(16px);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      margin-bottom:32px;
    }
    .profile-header{
      display:flex;
      align-items:center;
      gap:20px;
      margin-bottom:32px;
    }
    .profile-avatar{
      width:80px;
      height:80px;
      background:linear-gradient(135deg,var(--accent),var(--accent-3));
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      color:#fff;
      font-weight:700;
    }
    .profile-info h2{
      margin:0 0 4px 0;
      font-size:24px;
    }
    .profile-info p{
      margin:0;
      color:var(--text-light);
    }
    .preferences-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
    }
    .preference-card{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
    }
    .preference-card h4{
      margin:0 0 16px 0;
      font-size:16px;
      font-weight:600;
    }
    .checkbox-group{
      margin-bottom:12px;
    }
    .checkbox-group label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      padding:8px;
      border-radius:6px;
      transition:all 0.3s;
    }
    .checkbox-group label:hover{
      background:rgba(0,0,0,0.02);
    }
    .checkbox-group input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .topbar{
        padding:12px 16px;
      }
      .brand .title{
        display:none;
      }
      .main-container{
        padding:20px 16px;
      }
      .results-grid{
        grid-template-columns:1fr;
      }
      .notifications-panel{
        width:calc(100% - 32px);
        right:16px;
      }
    }

    /* Loading Spinner */
    .loading{
      display:none;
      text-align:center;
      padding:40px;
    }
    .loading.active{
      display:block;
    }
    .spinner{
      border:4px solid rgba(0,0,0,0.1);
      border-top:4px solid var(--accent);
      border-radius:50%;
      width:50px;
      height:50px;
      animation:spin 1s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin{
      0%{ transform:rotate(0deg); }
      100%{ transform:rotate(360deg); }
    }

    /* Toast Notifications */
    .toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:#fff;
      padding:16px 24px;
      border-radius:12px;
      box-shadow:var(--shadow-hover);
      display:none;
      align-items:center;
      gap:12px;
      z-index:3000;
      animation:slideIn 0.3s ease;
    }
    .toast.active{
      display:flex;
    }
    .toast.success{
      border-left:4px solid var(--success);
    }
    .toast.error{
      border-left:4px solid #f44336;
    }
    .toast.info{
      border-left:4px solid var(--accent);
    }
    @keyframes slideIn{
      from{
        transform:translateX(400px);
        opacity:0;
      }
      to{
        transform:translateX(0);
        opacity:1;
      }
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="brand" onclick="showHome()">
      <div class="logo">S</div>
      <div class="title">SmartPrice</div>
    </div>
    <div class="nav-icons">
      <div class="icon-btn" onclick="toggleNotifications()" title="Notificaciones">
        üîî
        <span class="badge" id="notifBadge">3</span>
      </div>
      <div class="icon-btn" onclick="showCart()" title="Carrito">
        üõí
        <span class="badge" id="cartBadge">0</span>
      </div>
      <div class="icon-btn" onclick="showProfile()" title="Perfil">
        üë§
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    
    <!-- Home View -->
    <div id="homeView">
      <!-- Search Section (CU-001) -->
      <div class="search-section">
        <h2 style="margin:0 0 20px 0; font-size:28px; font-weight:700;">
          Encuentra los mejores precios
        </h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Busca productos, marcas o categor√≠as..." />
          <button onclick="searchProducts()">üîç Buscar</button>
        </div>
        <div class="filters">
          <button class="filter-btn active" data-filter="all">Todos</button>
          <button class="filter-btn" data-filter="walmart">Walmart</button>
          <button class="filter-btn" data-filter="soriana">Soriana</button>
          <button class="filter-btn" data-filter="chedraui">Chedraui</button>
          <button class="filter-btn" data-filter="available">Solo disponibles</button>
          <button class="filter-btn" data-filter="offers">En oferta</button>
        </div>
      </div>

      <!-- Recommendations Section (CU-003) -->
      <div class="recommendations-section" id="recommendationsSection">
        <h3>üí° Recomendaciones personalizadas</h3>
        <div id="recommendationsList"></div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loadingSpinner">
        <div class="spinner"></div>
        <p>Buscando los mejores precios...</p>
      </div>

      <!-- Results Grid (CU-001, CU-006) -->
      <div class="results-grid" id="resultsGrid"></div>
    </div>

    <!-- Product Detail View (CU-002, CU-005) -->
    <div id="productDetailView" style="display:none;">
      <button onclick="showHome()" style="margin-bottom:20px; padding:10px 20px; border:none; background:var(--glass); border-radius:8px; cursor:pointer; font-weight:600;">
        ‚Üê Volver
      </button>
      <div style="background:var(--glass-2); backdrop-filter:blur(16px); border-radius:var(--radius); padding:32px; box-shadow:var(--shadow);">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:32px;">
          <div>
            <div id="productDetailImage" style="width:100%; height:400px; background:#f0f0f0; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:120px; margin-bottom:20px;"></div>
            <div id="productDetailInfo"></div>
          </div>
          <div>
            <h2 style="margin:0 0 20px 0;">Historial de Precios</h2>
            <div class="chart-container">
              <canvas id="priceChart"></canvas>
            </div>
            <h3 style="margin:24px 0 16px 0;">Informaci√≥n Nutricional</h3>
            <div class="nutrition-grid" id="nutritionInfo"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart View (CU-011) -->
    <div id="cartView" style="display:none;">
      <button onclick="showHome()" style="margin-bottom:20px; padding:10px 20px; border:none; background:var(--glass); border-radius:8px; cursor:pointer; font-weight:600;">
        ‚Üê Volver
      </button>
      <div class="shopping-list">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3 style="margin:0;">Mi Lista de Compra</h3>
          <button onclick="optimizeRoute()" style="padding:10px 20px; border:none; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
            üó∫Ô∏è Optimizar Ruta
          </button>
        </div>
        <div id="cartItems"></div>
        <div class="list-total">
          <div>
            <div class="total-label">Total estimado:</div>
            <div class="savings-badge" id="savingsBadge"></div>
          </div>
          <div class="total-amount" id="cartTotal">$0.00</div>
        </div>
        <div style="margin-top:20px; display:flex; gap:12px;">
          <button onclick="compareStores()" style="flex:1; padding:14px; border:none; background:var(--accent-3); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
            üìä Comparar Tiendas
          </button>
          <button onclick="clearCart()" style="padding:14px 24px; border:none; background:rgba(0,0,0,0.05); border-radius:8px; cursor:pointer; font-weight:600;">
            üóëÔ∏è Vaciar
          </button>
        </div>
      </div>
      
      <!-- Route Map (CU-004) -->
      <div id="routeSection" style="display:none;">
        <div style="background:var(--glass-2); backdrop-filter:blur(16px); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); margin-top:24px;">
          <h3 style="margin:0 0 20px 0;">üó∫Ô∏è Ruta Optimizada</h3>
          <div id="map"></div>
          <div id="routeInstructions" style="margin-top:20px;"></div>
        </div>
      </div>
    </div>

    <!-- Profile View (CU-007, CU-008, CU-010) -->
    <div id="profileView" style="display:none;">
      <button onclick="showHome()" style="margin-bottom:20px; padding:10px 20px; border:none; background:var(--glass); border-radius:8px; cursor:pointer; font-weight:600;">
        ‚Üê Volver
      </button>
      
      <!-- Login/Register Form -->
      <div id="authForm" class="profile-section">
        <h2 style="margin:0 0 24px 0;">Iniciar Sesi√≥n / Registrarse</h2>
        <div class="form-group">
          <label>Correo electr√≥nico</label>
          <input type="email" id="authEmail" placeholder="tu@email.com" />
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div style="display:flex; gap:12px;">
          <button onclick="login()" style="flex:1; padding:14px; border:none; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
            Iniciar Sesi√≥n
          </button>
          <button onclick="register()" style="flex:1; padding:14px; border:none; background:var(--accent-3); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
            Registrarse
          </button>
        </div>
      </div>

      <!-- User Profile (shown after login) -->
      <div id="userProfile" class="profile-section" style="display:none;">
        <div class="profile-header">
          <div class="profile-avatar" id="userAvatar">U</div>
          <div class="profile-info">
            <h2 id="userName">Usuario</h2>
            <p id="userEmail">usuario@email.com</p>
          </div>
          <button onclick="logout()" style="margin-left:auto; padding:10px 20px; border:none; background:rgba(0,0,0,0.05); border-radius:8px; cursor:pointer; font-weight:600;">
            Cerrar Sesi√≥n
          </button>
        </div>

        <h3 style="margin:0 0 20px 0;">Preferencias</h3>
        <div class="preferences-grid">
          <div class="preference-card">
            <h4>Supermercados Favoritos</h4>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Walmart</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Soriana</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Chedraui</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" /> HEB</label>
            </div>
          </div>

          <div class="preference-card">
            <h4>Notificaciones</h4>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Alertas de precio</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Ofertas personalizadas</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" /> Nuevos productos</label>
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" checked /> Recordatorios de compra</label>
            </div>
          </div>

          <div class="preference-card">
            <h4>Ubicaci√≥n</h4>
            <div class="form-group">
              <label>Ciudad</label>
              <input type="text" value="Ciudad de M√©xico" />
            </div>
            <div class="form-group">
              <label>Radio de b√∫squeda</label>
              <select>
                <option>5 km</option>
                <option selected>10 km</option>
                <option>20 km</option>
                <option>50 km</option>
              </select>
            </div>
          </div>
        </div>

        <button onclick="savePreferences()" style="margin-top:24px; padding:14px 32px; border:none; background:var(--success); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
          üíæ Guardar Cambios
        </button>
      </div>
    </div>

  </div>

  <!-- Notifications Panel (CU-009) -->
  <div class="notifications-panel" id="notificationsPanel">
    <div class="notifications-header">
      Notificaciones
    </div>
    <div class="notifications-list" id="notificationsList"></div>
  </div>

  <!-- Report Modal (CU-012) -->
  <div class="modal" id="reportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ö†Ô∏è Reportar Precio Incorrecto</h2>
        <button class="modal-close" onclick="closeReportModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Producto</label>
          <input type="text" id="reportProduct" readonly />
        </div>
        <div class="form-group">
          <label>Tienda</label>
          <select id="reportStore">
            <option>Walmart</option>
            <option>Soriana</option>
            <option>Chedraui</option>
            <option>HEB</option>
          </select>
        </div>
        <div class="form-group">
          <label>Precio observado</label>
          <input type="number" id="reportPrice" placeholder="0.00" step="0.01" />
        </div>
        <div class="form-group">
          <label>Evidencia (foto)</label>
          <div class="file-upload" onclick="document.getElementById('reportImage').click()">
            <input type="file" id="reportImage" accept="image/*" onchange="handleImageUpload(this)" />
            <p id="uploadText">üì∑ Haz clic para subir una foto</p>
          </div>
        </div>
        <div class="form-group">
          <label>Comentarios adicionales</label>
          <textarea id="reportComments" placeholder="Describe la discrepancia..."></textarea>
        </div>
      </div>
      <button onclick="submitReport()" style="width:100%; padding:14px; border:none; background:var(--accent); color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">
        Enviar Reporte
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toastIcon">‚úì</span>
    <span id="toastMessage">Mensaje</span>
  </div>

  <!-- Chart.js for price history -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Main JavaScript -->
  <script>
    // ========== DATA MODELS ==========
    
    // Mock product database
    const productsDB = [
      {
        id: 1,
        name: "Leche Lala Entera 1L",
        category: "L√°cteos",
        image: "ü•õ",
        stores: [
          { name: "Walmart", price: 24.50, available: true, stock: "Alto", location: { lat: 19.4326, lng: -99.1332 } },
          { name: "Soriana", price: 25.90, available: true, stock: "Medio", location: { lat: 19.4286, lng: -99.1276 } },
          { name: "Chedraui", price: 23.90, available: true, stock: "Bajo", location: { lat: 19.4366, lng: -99.1386 } }
        ],
        priceHistory: [
          { date: "2025-10-11", price: 26.50 },
          { date: "2025-10-18", price: 25.90 },
          { date: "2025-10-25", price: 24.90 },
          { date: "2025-11-01", price: 25.50 },
          { date: "2025-11-08", price: 24.50 }
        ],
        nutrition: {
          calories: 146,
          protein: 7.7,
          carbs: 11.4,
          fat: 7.9,
          calcium: 276,
          vitaminD: 2.5
        }
      },
      {
        id: 2,
        name: "Pan Bimbo Blanco Grande",
        category: "Panader√≠a",
        image: "üçû",
        stores: [
          { name: "Walmart", price: 42.00, available: true, stock: "Alto", location: { lat: 19.4326, lng: -99.1332 } },
          { name: "Soriana", price: 44.50, available: false, stock: "Agotado", location: { lat: 19.4286, lng: -99.1276 } },
          { name: "Chedraui", price: 41.50, available: true, stock: "Alto", location: { lat: 19.4366, lng: -99.1386 } }
        ],
        priceHistory: [
          { date: "2025-10-11", price: 40.00 },
          { date: "2025-10-18", price: 41.00 },
          { date: "2025-10-25", price: 41.50 },
          { date: "2025-11-01", price: 42.50 },
          { date: "2025-11-08", price: 42.00 }
        ],
        nutrition: {
          calories: 265,
          protein: 9,
          carbs: 49,
          fat: 3.2,
          fiber: 2.7,
          sodium: 540
        }
      },
      {
        id: 3,
        name: "Huevo San Juan 18 pzas",
        category: "Huevos",
        image: "ü•ö",
        stores: [
          { name: "Walmart", price: 58.90, available: true, stock: "Medio", location: { lat: 19.4326, lng: -99.1332 } },
          { name: "Soriana", price: 56.50, available: true, stock: "Alto", location: { lat: 19.4286, lng: -99.1276 } },
          { name: "Chedraui", price: 59.90, available: true, stock: "Bajo", location: { lat: 19.4366, lng: -99.1386 } }
        ],
        priceHistory: [
          { date: "2025-10-11", price: 62.00 },
          { date: "2025-10-18", price: 60.50 },
          { date: "2025-10-25", price: 58.00 },
          { date: "2025-11-01", price: 57.50 },
          { date: "2025-11-08", price: 58.90 }
        ],
        nutrition: {
          calories: 143,
          protein: 12.6,
          carbs: 0.7,
          fat: 9.5,
          cholesterol: 372,
          vitaminB12: 0.9
        }
      },
      {
        id: 4,
        name: "Coca-Cola 2L",
        category: "Bebidas",
        image: "ü•§",
        stores: [
          { name: "Walmart", price: 28.50, available: true, stock: "Alto", location: { lat: 19.4326, lng: -99.1332 } },
          { name: "Soriana", price: 27.90, available: true, stock: "Alto", location: { lat: 19.4286, lng: -99.1276 } },
          { name: "Chedraui", price: 29.00, available: true, stock: "Medio", location: { lat: 19.4366, lng: -99.1386 } }
        ],
        priceHistory: [
          { date: "2025-10-11", price: 30.00 },
          { date: "2025-10-18", price: 29.50 },
          { date: "2025-10-25", price: 28.90 },
          { date: "2025-11-01", price: 28.00 },
          { date: "2025-11-08", price: 28.50 }
        ],
        nutrition: {
          calories: 420,
          protein: 0,
          carbs: 105,
          fat: 0,
          sugar: 105,
          sodium: 70
        }
      }
    ];

    // User state
    let currentUser = null;
    let shoppingCart = [];
    let notifications = [
      {
        id: 1,
        title: "¬°Oferta en Leche Lala!",
        message: "El precio baj√≥ de $26.50 a $24.50 en Walmart",
        time: "Hace 2 horas",
        unread: true,
        productId: 1
      },
      {
        id: 2,
        title: "Producto disponible",
        message: "Pan Bimbo ya est√° disponible en Chedraui",
        time: "Hace 5 horas",
        unread: true,
        productId: 2
      },
      {
        id: 3,
        title: "Ahorro potencial",
        message: "Puedes ahorrar $45 comprando en diferentes tiendas",
        time: "Hace 1 d√≠a",
        unread: false
      }
    ];

    // ========== INITIALIZATION ==========
    
    window.onload = function() {
      initializeApp();
    };

    function initializeApp() {
      // Load saved cart
      const savedCart = localStorage.getItem('smartprice_cart');
      if (savedCart) {
        shoppingCart = JSON.parse(savedCart);
        updateCartBadge();
      }

      // Load saved user
      const savedUser = localStorage.getItem('smartprice_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
      }

      // Show initial recommendations
      showRecommendations();
      
      // Update notifications
      updateNotifications();

      // Setup filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          filterProducts(this.dataset.filter);
        });
      });

      // Setup search on Enter
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProducts();
        }
      });
    }

    // ========== NAVIGATION ==========
    
    function showHome() {
      document.getElementById('homeView').style.display = 'block';
      document.getElementById('productDetailView').style.display = 'none';
      document.getElementById('cartView').style.display = 'none';
      document.getElementById('profileView').style.display = 'none';
    }

    function showCart() {
      document.getElementById('homeView').style.display = 'none';
      document.getElementById('productDetailView').style.display = 'none';
      document.getElementById('cartView').style.display = 'block';
      document.getElementById('profileView').style.display = 'none';
      renderCart();
    }

    function showProfile() {
      document.getElementById('homeView').style.display = 'none';
      document.getElementById('productDetailView').style.display = 'none';
      document.getElementById('cartView').style.display = 'none';
      document.getElementById('profileView').style.display = 'block';
      
      if (currentUser) {
        document.getElementById('authForm').style.display = 'none';
        document.getElementById('userProfile').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
      } else {
        document.getElementById('authForm').style.display = 'block';
        document.getElementById('userProfile').style.display = 'none';
      }
    }

    // ========== SEARCH & FILTER (CU-001) ==========
    
    function searchProducts() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      
      // Show loading
      document.getElementById('loadingSpinner').classList.add('active');
      document.getElementById('resultsGrid').innerHTML = '';

      // Simulate API call delay
      setTimeout(() => {
        let results = productsDB;
        
        if (query) {
          results = productsDB.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.category.toLowerCase().includes(query)
          );
        }

        displayResults(results);
        document.getElementById('loadingSpinner').classList.remove('active');
      }, 800);
    }

    function filterProducts(filter) {
      let results = productsDB;

      if (filter === 'available') {
        results = productsDB.filter(p => 
          p.stores.some(s => s.available)
        );
      } else if (filter !== 'all') {
        results = productsDB.filter(p => 
          p.stores.some(s => s.name.toLowerCase() === filter)
        );
      }

      displayResults(results);
    }

    function displayResults(products) {
      const grid = document.getElementById('resultsGrid');
      grid.innerHTML = '';

      products.forEach(product => {
        // Find best price
        const availableStores = product.stores.filter(s => s.available);
        if (availableStores.length === 0) return;

        const bestStore = availableStores.reduce((min, store) => 
          store.price < min.price ? store : min
        );

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <button class="report-btn" onclick="openReportModal('${product.name}')" title="Reportar precio">‚ö†Ô∏è</button>
          <div class="product-image">${product.image}</div>
          <div class="product-name">${product.name}</div>
          <div class="product-store">üè™ ${bestStore.name}</div>
          <div class="product-price">$${bestStore.price.toFixed(2)}</div>
          <div class="product-availability ${bestStore.stock === 'Alto' ? 'available' : bestStore.stock === 'Medio' ? 'limited' : 'unavailable'}">
            ${bestStore.stock === 'Alto' ? '‚úì Disponible' : bestStore.stock === 'Medio' ? '‚ö† Stock limitado' : '‚úó Agotado'}
          </div>
          <div class="product-actions">
            <button class="btn-action btn-primary" onclick="addToCart(${product.id}, '${bestStore.name}')">
              Agregar al carrito
            </button>
            <button class="btn-action btn-secondary" onclick="showProductDetail(${product.id})">
              Ver detalles
            </button>
          </div>
        `;
        grid.appendChild(card);
      });

      if (products.length === 0) {
        grid.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-light);">No se encontraron productos</p>';
      }
    }

    // ========== PRODUCT DETAIL (CU-002, CU-005, CU-006) ==========
    
    function showProductDetail(productId) {
      const product = productsDB.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('homeView').style.display = 'none';
      document.getElementById('productDetailView').style.display = 'block';

      // Display product info
      document.getElementById('productDetailImage').textContent = product.image;
      
      const infoHTML = `
        <h1 style="margin:0 0 16px 0; font-size:32px;">${product.name}</h1>
        <p style="color:var(--text-light); margin-bottom:24px;">Categor√≠a: ${product.category}</p>
        
        <h3 style="margin:0 0 16px 0;">Comparaci√≥n de Precios</h3>
        ${product.stores.map(store => `
          <div style="background:#fff; border-radius:8px; padding:16px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:600;">${store.name}</div>
              <div style="font-size:14px; color:var(--text-light);">
                ${store.available ? '‚úì Disponible' : '‚úó No disponible'} ‚Ä¢ Stock: ${store.stock}
              </div>
            </div>
            <div style="font-size:24px; font-weight:700; color:var(--accent);">
              $${store.price.toFixed(2)}
            </div>
          </div>
        `).join('')}
      `;
      document.getElementById('productDetailInfo').innerHTML = infoHTML;

      // Display price history chart (CU-002)
      displayPriceChart(product);

      // Display nutrition info (CU-005)
      displayNutritionInfo(product);
    }

    function displayPriceChart(product) {
      const ctx = document.getElementById('priceChart');
      if (window.priceChartInstance) {
        window.priceChartInstance.destroy();
      }

      window.priceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: product.priceHistory.map(h => h.date),
          datasets: [{
            label: 'Precio',
            data: product.priceHistory.map(h => h.price),
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30,136,229,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    function displayNutritionInfo(product) {
      const container = document.getElementById('nutritionInfo');
      if (!product.nutrition) {
        container.innerHTML = '<p style="color:var(--text-light);">Informaci√≥n nutricional no disponible</p>';
        return;
      }

      const nutritionLabels = {
        calories: 'Calor√≠as',
        protein: 'Prote√≠na (g)',
        carbs: 'Carbohidratos (g)',
        fat: 'Grasas (g)',
        fiber: 'Fibra (g)',
        sugar: 'Az√∫car (g)',
        sodium: 'Sodio (mg)',
        calcium: 'Calcio (mg)',
        cholesterol: 'Colesterol (mg)',
        vitaminD: 'Vitamina D (Œºg)',
        vitaminB12: 'Vitamina B12 (Œºg)'
      };

      container.innerHTML = Object.entries(product.nutrition)
        .map(([key, value]) => `
          <div class="nutrition-item">
            <div class="value">${value}</div>
            <div class="label">${nutritionLabels[key] || key}</div>
          </div>
        `).join('');
    }

    // ========== RECOMMENDATIONS (CU-003) ==========
    
    function showRecommendations() {
      const recommendations = [
        {
          icon: 'üí∞',
          title: 'Ahorra $12 en tu lista',
          description: 'Compra leche en Chedraui en lugar de Soriana'
        },
        {
          icon: 'üî•',
          title: 'Oferta destacada',
          description: 'Huevos San Juan con 8% de descuento en Soriana'
        },
        {
          icon: '‚≠ê',
          title: 'Producto recomendado',
          description: 'Basado en tus compras anteriores: Pan Integral Bimbo'
        }
      ];

      const container = document.getElementById('recommendationsList');
      container.innerHTML = recommendations.map(rec => `
        <div class="recommendation-card">
          <div class="icon">${rec.icon}</div>
          <div class="content">
            <div class="title">${rec.title}</div>
            <div class="description">${rec.description}</div>
          </div>
        </div>
      `).join('');
    }

    // ========== SHOPPING CART (CU-011) ==========
    
    function addToCart(productId, storeName) {
      const product = productsDB.find(p => p.id === productId);
      const store = product.stores.find(s => s.name === storeName);

      const cartItem = {
        productId: product.id,
        name: product.name,
        store: storeName,
        price: store.price,
        image: product.image,
        quantity: 1
      };

      // Check if already in cart
      const existing = shoppingCart.find(item => 
        item.productId === productId && item.store === storeName
      );

      if (existing) {
        existing.quantity++;
      } else {
        shoppingCart.push(cartItem);
      }

      saveCart();
      updateCartBadge();
      showToast('Producto agregado al carrito', 'success');
    }

    function removeFromCart(index) {
      shoppingCart.splice(index, 1);
      saveCart();
      updateCartBadge();
      renderCart();
      showToast('Producto eliminado', 'info');
    }

    function clearCart() {
      if (confirm('¬øEst√°s seguro de vaciar el carrito?')) {
        shoppingCart = [];
        saveCart();
        updateCartBadge();
        renderCart();
        showToast('Carrito vaciado', 'info');
      }
    }

    function saveCart() {
      localStorage.setItem('smartprice_cart', JSON.stringify(shoppingCart));
    }

    function updateCartBadge() {
      document.getElementById('cartBadge').textContent = shoppingCart.length;
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      
      if (shoppingCart.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-light);">Tu carrito est√° vac√≠o</p>';
        document.getElementById('cartTotal').textContent = '$0.00';
        document.getElementById('savingsBadge').textContent = '';
        return;
      }

      container.innerHTML = shoppingCart.map((item, index) => `
        <div class="list-item">
          <div style="font-size:32px; margin-right:12px;">${item.image}</div>
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div style="font-size:14px; color:var(--text-light);">${item.store} ‚Ä¢ Cantidad: ${item.quantity}</div>
          </div>
          <div style="text-align:right;">
            <div class="item-price">$${(item.price * item.quantity).toFixed(2)}</div>
            <div class="item-actions">
              <button onclick="removeFromCart(${index})" style="background:rgba(244,67,54,0.1); color:#f44336;">
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `).join('');

      // Calculate total
      const total = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);

      // Calculate potential savings
      const savings = calculateSavings();
      if (savings > 0) {
        document.getElementById('savingsBadge').textContent = `üí∞ Puedes ahorrar $${savings.toFixed(2)} optimizando tu compra`;
      } else {
        document.getElementById('savingsBadge').textContent = '‚úì Ya tienes los mejores precios';
      }
    }

    function calculateSavings() {
      let currentTotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      let bestTotal = 0;

      shoppingCart.forEach(item => {
        const product = productsDB.find(p => p.id === item.productId);
        const availableStores = product.stores.filter(s => s.available);
        const bestPrice = Math.min(...availableStores.map(s => s.price));
        bestTotal += bestPrice * item.quantity;
      });

      return currentTotal - bestTotal;
    }

    function compareStores() {
      // Group by store and calculate totals
      const storeGroups = {};
      
      shoppingCart.forEach(item => {
        if (!storeGroups[item.store]) {
          storeGroups[item.store] = 0;
        }
        storeGroups[item.store] += item.price * item.quantity;
      });

      let message = 'Comparaci√≥n por tienda:\n\n';
      Object.entries(storeGroups).forEach(([store, total]) => {
        message += `${store}: $${total.toFixed(2)}\n`;
      });

      alert(message);
    }

    // ========== ROUTE OPTIMIZATION (CU-004) ==========
    
    function optimizeRoute() {
      document.getElementById('routeSection').style.display = 'block';
      
      // Initialize map
      setTimeout(() => {
        const map = L.map('map').setView([19.4326, -99.1332], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Add markers for stores
        const stores = [...new Set(shoppingCart.map(item => item.store))];
        const storeLocations = {
          'Walmart': [19.4326, -99.1332],
          'Soriana': [19.4286, -99.1276],
          'Chedraui': [19.4366, -99.1386]
        };

        stores.forEach(store => {
          if (storeLocations[store]) {
            L.marker(storeLocations[store])
              .addTo(map)
              .bindPopup(`<b>${store}</b>`);
          }
        });

        // Show route instructions
        document.getElementById('routeInstructions').innerHTML = `
          <h4 style="margin:0 0 12px 0;">Instrucciones de ruta</h4>
          <ol style="margin:0; padding-left:20px;">
            ${stores.map((store, i) => `
              <li style="margin-bottom:8px;">
                <strong>${store}</strong> - ${getStoreProducts(store).join(', ')}
              </li>
            `).join('')}
          </ol>
          <p style="margin-top:16px; color:var(--text-light);">
            üìç Distancia total estimada: ${(stores.length * 3.5).toFixed(1)} km<br>
            ‚è±Ô∏è Tiempo estimado: ${(stores.length * 15)} minutos
          </p>
        `;
      }, 100);
    }

    function getStoreProducts(storeName) {
      return shoppingCart
        .filter(item => item.store === storeName)
        .map(item => item.name);
    }

    // ========== NOTIFICATIONS (CU-009) ==========
    
    function toggleNotifications() {
      const panel = document.getElementById('notificationsPanel');
      panel.classList.toggle('active');
      
      if (panel.classList.contains('active')) {
        // Mark as read
        notifications.forEach(n => n.unread = false);
        updateNotifications();
        document.getElementById('notifBadge').textContent = '0';
      }
    }

    function updateNotifications() {
      const container = document.getElementById('notificationsList');
      const unreadCount = notifications.filter(n => n.unread).length;
      
      document.getElementById('notifBadge').textContent = unreadCount;
      
      container.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.unread ? 'unread' : ''}" onclick="handleNotificationClick(${notif.id})">
          <div class="notif-title">${notif.title}</div>
          <div class="notif-message">${notif.message}</div>
          <div class="notif-time">${notif.time}</div>
        </div>
      `).join('');
    }

    function handleNotificationClick(notifId) {
      const notif = notifications.find(n => n.id === notifId);
      if (notif && notif.productId) {
        toggleNotifications();
        showProductDetail(notif.productId);
      }
    }

    // ========== AUTH (CU-007, CU-008) ==========
    
    function login() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;

      if (!email || !password) {
        showToast('Por favor completa todos los campos', 'error');
        return;
      }

      // Simulate login
      currentUser = {
        name: email.split('@')[0],
        email: email
      };

      localStorage.setItem('smartprice_user', JSON.stringify(currentUser));
      showToast('Sesi√≥n iniciada correctamente', 'success');
      showProfile();
    }

    function register() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;

      if (!email || !password) {
        showToast('Por favor completa todos los campos', 'error');
        return;
      }

      if (password.length < 6) {
        showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
      }

      // Simulate registration
      currentUser = {
        name: email.split('@')[0],
        email: email
      };

      localStorage.setItem('smartprice_user', JSON.stringify(currentUser));
      showToast('Cuenta creada exitosamente', 'success');
      showProfile();
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('smartprice_user');
      showToast('Sesi√≥n cerrada', 'info');
      showProfile();
    }

    function savePreferences() {
      showToast('Preferencias guardadas correctamente', 'success');
    }

    // ========== REPORT (CU-012) ==========
    
    function openReportModal(productName) {
      document.getElementById('reportProduct').value = productName;
      document.getElementById('reportModal').classList.add('active');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('active');
      document.getElementById('reportPrice').value = '';
      document.getElementById('reportComments').value = '';
      document.getElementById('uploadText').textContent = 'üì∑ Haz clic para subir una foto';
    }

    function handleImageUpload(input) {
      if (input.files && input.files[0]) {
        document.getElementById('uploadText').textContent = '‚úì ' + input.files[0].name;
      }
    }

    function submitReport() {
      const product = document.getElementById('reportProduct').value;
      const store = document.getElementById('reportStore').value;
      const price = document.getElementById('reportPrice').value;
      const comments = document.getElementById('reportComments').value;

      if (!price) {
        showToast('Por favor ingresa el precio observado', 'error');
        return;
      }

      // Simulate report submission
      console.log('Report submitted:', { product, store, price, comments });
      
      showToast('Gracias por tu reporte, ser√° revisado por el equipo de SmartPrice', 'success');
      closeReportModal();
    }

    // ========== UTILITIES ==========
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      toast.className = 'toast ' + type;
      
      if (type === 'success') icon.textContent = '‚úì';
      else if (type === 'error') icon.textContent = '‚úï';
      else icon.textContent = '‚Ñπ';

      msg.textContent = message;
      toast.classList.add('active');

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
      }
    };
  </script>

</body>
</html>
'''

# Save the enhanced code
with open('/mnt/data/smartprice_mejorado.html', 'w', encoding='utf-8') as f:
    f.write(enhanced_code)

print("‚úÖ C√≥digo mejorado creado exitosamente!")
print(f"üìÑ Tama√±o: {len(enhanced_code):,} caracteres")
print(f"üì¶ Archivo guardado: smartprice_mejorado.html")
