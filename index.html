<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartPrice ‚Äî Tu compra inteligente</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Estilos -->
  <style>
    :root{
      --bg: #f8fafc;
      --glass: rgba(255,255,255,0.8);
      --panel: #ffffff;
      --accent: #1e88e5;      /* azul principal */
      --accent-2: #ff6d00;    /* naranja acento */
      --accent-3: #5e35b1;    /* morado secundario */
      --success: #43a047;
      --muted: #546e7a;
      --card: linear-gradient(180deg, #ffffff, #fafafa);
      --radius: 16px;
      --glass-2: rgba(255,255,255,0.9);
      --text: #333333;        /* Mejor contraste - Cambiado de #1a1a1a a #333 */
      --text-light: #78909c;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --shadow-hover: 0 15px 40px rgba(0,0,0,0.12);
      color-scheme: light;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; font-family: 'Poppins', sans-serif; background: linear-gradient(180deg,#f8fafc 0%, #e3f2fd 100%); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-size: 16px; } /* Tama√±o base aumentado */

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:1200;
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 24px; gap:16px;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.85);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .brand{ display:flex; gap:12px; align-items:center; cursor:pointer; }
    .brand .logo{
      background: linear-gradient(135deg,var(--accent),var(--accent-3));
      width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800; color:white; box-shadow:0 8px 30px rgba(30,136,229,0.2);
    }
    .brand .title{ font-weight:700; letter-spacing:0.2px; font-size:1.5rem; color:var(--accent); } /* Tama√±o aumentado */
    .navlinks{ display:flex; gap:10px; align-items:center; }
    .navlinks button{ background:transparent; border:0; color:var(--muted); padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; transition: all 0.2s ease; font-size: 1rem; } /* Tama√±o aumentado */
    .navlinks button.active, .navlinks button:hover{ color:var(--accent); background:rgba(30,136,229,0.08); box-shadow:0 6px 18px rgba(0,0,0,0.05); }

    /* Search box */
    .search-wrap{ display:flex; gap:10px; align-items:center; }
    .search-input{
      background:white; border:1px solid rgba(0,0,0,0.08);
      color:var(--text); padding:12px 18px; border-radius:12px; width:380px; outline:none; font-size: 1rem; /* Tama√±o aumentado */
      transition: box-shadow .2s, transform .12s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .search-input:focus{ box-shadow:0 8px 30px rgba(30,136,229,0.15); transform: translateY(-2px); border-color: var(--accent); }

    /* Bottom Navigation - Mobile */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid rgba(0,0,0,0.05);
      padding: 10px;
      justify-content: space-around;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .bottom-nav button {
      background: transparent;
      border: 0;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 60px;
    }
    .bottom-nav button.active {
      color: var(--accent);
      background: rgba(30,136,229,0.08);
    }

    /* Layout container */
    .wrap{ max-width:1200px; margin:32px auto; padding:0 24px; }

    /* Section general */
    section.app-section{ display:none; margin-bottom:40px; animation: fadeIn .3s ease; }
    section.app-section.active{ display:block; }

    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px);} to{opacity:1; transform:none;} }

    /* Card */
    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.03);
    }

    /* Splash */
    .splash{
      display:flex; gap:24px; align-items:center; justify-content:space-between; padding:32px; border-radius:20px;
      background: linear-gradient(135deg, rgba(30,136,229,0.1), rgba(255,109,0,0.05));
      border:1px solid rgba(255,255,255,0.8);
      box-shadow: var(--shadow);
    }
    .splash h1{ margin:0; font-size:2.8rem; line-height:1.1; color:var(--accent); } /* Tama√±o aumentado */
    .splash p{ color:var(--muted); margin-top:12px; margin-bottom:20px; max-width:560px; font-size:1.125rem; } /* Tama√±o aumentado a 18px */

    /* Grid of products */
    .product-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:22px; margin-top:22px; }
    .product-card{
      border-radius:16px; overflow:hidden; position:relative; padding:0; background:white; transition: transform .25s ease, box-shadow .25s ease;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow: var(--shadow);
    }
    .product-card:hover{ transform: translateY(-10px); box-shadow: var(--shadow-hover); }
    .product-image{ width:100%; height:180px; object-fit:cover; display:block; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 14px; }
    .product-info{ padding:18px; display:flex; flex-direction:column; gap:10px; }
    .product-title{ font-weight:700; margin:0; color:var(--text); font-size: 1.05rem; } /* Tama√±o aumentado */
    .product-cat{ color:var(--accent); font-weight:600; font-size:0.9rem; background: rgba(30,136,229,0.08); padding:4px 10px; border-radius:20px; display:inline-block; }
    .product-row{ display:flex; justify-content:space-between; align-items:center; gap:14px; margin-top:10px; }
    .price{ font-weight:800; color: var(--accent-2); font-size:1.3rem; } /* Tama√±o aumentado */
    .store{ color:var(--muted); font-size:0.9rem; } /* Tama√±o aumentado */

    .btn-primary{
      background: linear-gradient(90deg,var(--accent), #1565c0); border:0; color:white; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700; font-size: 1rem; /* Tama√±o aumentado */
      box-shadow:0 8px 25px rgba(30,136,229,0.2);
      transition: all 0.2s ease;
    }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow:0 12px 30px rgba(30,136,229,0.3); }
    .btn-ghost{ background:transparent; border:1px solid rgba(0,0,0,0.08); padding:10px 14px; color:var(--muted); border-radius:10px; cursor:pointer; transition: all 0.2s ease; font-size: 1rem; } /* Tama√±o aumentado */
    .btn-ghost:hover{ background: rgba(0,0,0,0.02); border-color: var(--accent); color: var(--accent); }

    /* Cart panel and summary */
    .cart-panel{ width:100%; padding:18px; border-radius:16px; background: white; border:1px solid rgba(0,0,0,0.03); box-shadow: var(--shadow); }
    .cart-item{ display:flex; gap:16px; align-items:center; padding:12px 0; border-bottom:1px dashed rgba(0,0,0,0.05); }
    .cart-item:last-child{ border-bottom:0; }

    /* Comparison table */
    .table{ width:100%; color:var(--text); border-collapse:collapse; font-size: 1rem; } /* Tama√±o aumentado */
    .table th, .table td { padding:14px 12px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.05); color:var(--muted); }
    .table tr.best{ background: linear-gradient(90deg, rgba(67,160,71,0.08), rgba(30,136,229,0.05)); color:var(--text); border-left:4px solid var(--success); }

    /* Chat */
    .chat-window{ background: white; padding:16px; border-radius:16px; height:360px; overflow:auto; display:flex; flex-direction:column; gap:12px; box-shadow: var(--shadow); }
    .bubble{ max-width:78%; padding:12px 16px; border-radius:18px; font-size:1rem; } /* Tama√±o aumentado */
    .bubble.bot{ align-self:flex-start; background: rgba(0,0,0,0.03); color:var(--text); border:1px solid rgba(0,0,0,0.05); }
    .bubble.user{ align-self:flex-end; background: linear-gradient(90deg,var(--accent), #1565c0); color:white; }

    /* Profile */
    .profile-card{ display:flex; gap:20px; align-items:center; padding:16px; border-radius:16px; background: white; box-shadow: var(--shadow); }
    .avatar{ width:80px; height:80px; border-radius:20px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; font-weight:800; background: linear-gradient(135deg,var(--accent-3),var(--accent)); color:white; }

    /* Footer */
    footer{ text-align:center; padding:24px; color:var(--muted); font-size:1rem; margin-top:32px; } /* Tama√±o aumentado */

    /* Responsive */
    @media (max-width:960px){
      .search-input{ width:240px; }
      .splash{ flex-direction:column; gap:18px; }
      .splash h1{ font-size:2.4rem; } /* Ajustado */
    }
    
    @media (max-width:768px) {
      .topbar {
        flex-wrap: wrap;
        padding: 12px 16px;
      }
      
      .brand .title {
        font-size: 1.3rem; /* Ajustado */
      }
      
      .search-input {
        width: 100%;
        max-width: 300px;
      }
      
      .splash {
        padding: 20px;
      }
      
      .splash h1 {
        font-size: 2.2rem; /* Ajustado */
      }
      
      .splash p {
        font-size: 1rem; /* Ajustado */
      }
      
      .splash > div:first-child,
      .splash > div:last-child {
        max-width: 100% !important;
        width: 100% !important;
      }
      
      .wrap {
        padding: 0 16px;
        margin: 20px auto; /* Ajustado */
      }
      
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .product-info {
        padding: 14px;
      }
      
      .navlinks {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
        overflow-x: auto;
        display: none; /* Oculto en m√≥viles */
      }
      
      .navlinks button {
        padding: 8px 12px;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      
      .search-wrap {
        order: 2;
        margin-top: 10px;
        width: 100%;
        justify-content: center;
      }
      
      .brand {
        order: 1;
      }
      
      /* Mostrar navegaci√≥n inferior en m√≥viles */
      .bottom-nav {
        display: flex;
      }
      
      /* Ajustes para secciones espec√≠ficas */
      section.app-section > div:first-child {
        flex-direction: column;
        align-items: flex-start;
      }
      
      section.app-section > div:first-child > div:last-child {
        margin-top: 16px;
        width: 100%;
      }
      
      /* Ajustes para formularios */
      input, select {
        max-width: 100%;
        font-size: 16px; /* Previene zoom en iOS */
      }
      
      /* Ajustes para tablas */
      .table {
        font-size: 0.9rem; /* Ajustado */
      }
      
      .table th, .table td {
        padding: 10px 8px;
      }
      
      /* Ajustes para el carrito */
      .cart-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .cart-item > div:last-child {
        width: 100%;
        text-align: left;
      }
      
      /* Ajustes para el perfil */
      .profile-card {
        flex-direction: column;
        text-align: center;
      }
      
      /* Ajustes para el mapa */
      .map-overlay .map-controls {
        max-width: 95%;
        padding: 12px 16px;
      }
      
      .map-overlay .map-controls button {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
    }
    
    @media (max-width:680px){
      .search-input{ width:100%; max-width: 280px; }
      .product-image{ height:160px; }
      .splash h1{ font-size:2rem; } /* Ajustado */
    }
    
    @media (max-width:480px) {
      .topbar {
        padding: 10px 12px;
      }
      
      .splash h1 {
        font-size: 1.8rem; /* Ajustado */
      }
      
      .splash p {
        font-size: 0.95rem; /* Ajustado */
      }
      
      .product-grid {
        grid-template-columns: 1fr;
      }
      
      .product-card {
        margin: 0 auto;
        max-width: 100%;
      }
      
      .navlinks button {
        padding: 6px 10px;
        font-size: 0.8rem;
      }
      
      .btn-primary, .btn-ghost {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      
      .card {
        padding: 16px;
      }
      
      .search-input {
        font-size: 0.9rem;
        padding: 10px 14px;
      }
      
      .wrap {
        margin: 16px auto; /* Ajustado */
      }
      
      /* Ajustes para el chat */
      .bubble {
        max-width: 90%;
        padding: 10px 14px;
      }
      
      /* Ajustes para elementos de formulario en perfil */
      #profileInputName, #profileInputEmail {
        font-size: 0.9rem;
        padding: 10px;
      }
    }
    
    @media (max-width:360px) {
      .splash h1 {
        font-size: 1.6rem; /* Ajustado */
      }
      
      .navlinks {
        gap: 4px;
      }
      
      .navlinks button {
        padding: 5px 8px;
        font-size: 0.75rem;
      }
      
      .brand .logo {
        width: 40px;
        height: 40px;
      }
      
      .brand .title {
        font-size: 1rem; /* Ajustado */
      }
      
      .btn-primary, .btn-ghost {
        padding: 7px 10px;
        font-size: 0.85rem;
      }
    }

    /* small utilities */
    .muted{ color:var(--muted); font-size:1rem; }
    .small{ font-size:0.9rem; color:var(--muted); } /* Tama√±o aumentado */
    .gap-8{ gap:8px; }
    .mt-12{ margin-top:12px; }
    .mb-6{ margin-bottom:6px; }
    .text-center{ text-align: center; }
    
    /* New styles for additional features */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-left: 8px;
    }
    .badge-success {
      background: rgba(67, 160, 71, 0.1);
      color: var(--success);
    }
    .badge-warning {
      background: rgba(255, 152, 0, 0.1);
      color: #ff9800;
    }
    .badge-info {
      background: rgba(30, 136, 229, 0.1);
      color: var(--accent);
    }
    .badge-danger {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
    }
    .price-history {
      height: 140px;
      border-radius: 12px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      margin-top: 10px;
    }
    .prediction-badge {
      background: linear-gradient(90deg, var(--accent-3), var(--accent));
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-top: 8px;
      display: inline-block;
    }
    .confidence-bar {
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      margin-top: 4px;
      overflow: hidden;
    }
    .confidence-fill {
      height: 100%;
      border-radius: 3px;
    }
    .high-confidence {
      background: var(--success);
      width: 85%;
    }
    .medium-confidence {
      background: #ff9800;
      width: 60%;
    }
    .low-confidence {
      background: #f44336;
      width: 30%;
    }
    .notification-item {
      padding: 12px;
      border-radius: 10px;
      background: white;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--accent);
    }
    .report-form {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-top: 16px;
    }
    
    /* Graph styles */
    .graph-container {
      width: 100%;
      height: 120px;
      position: relative;
      overflow: hidden;
    }
    .graph-line {
      fill: none;
      stroke: var(--accent);
      stroke-width: 2;
    }
    .graph-area {
      fill: rgba(30, 136, 229, 0.1);
    }
    .graph-point {
      fill: var(--accent);
      r: 4;
    }
    
    /* Logo styles */
    .logo-img {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      object-fit: contain;
    }
    .chat-logo {
      width: 24px;
      height: 24px;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    /* Map styles */
    .map-container {
      width: 100%;
      height: 380px;
      border-radius: 16px;
      overflow: hidden;
      background: #f5f5f5;
      position: relative;
    }
    
    .map-overlay {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
    }
    
    .map-controls {
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      max-width: 90%;
    }
    
    /* Image fallback */
    .image-fallback {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      color: var(--muted);
      font-weight: 600;
      text-align: center;
      padding: 10px;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }
    .empty-state-title {
      font-weight: 700;
      margin-bottom: 8px;
    }
    .empty-state-description {
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* Toast improvements */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      padding: 14px 18px;
      background: white;
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 12px;
      box-shadow: var(--shadow-hover);
      color: var(--text);
      z-index: 9999;
      font-weight: 600;
      transition: opacity 0.3s ease;
    }
    .toast.success {
      background: var(--success);
      color: white;
    }
    .toast.error {
      background: #f44336;
      color: white;
    }
    .toast.info {
      background: var(--accent);
      color: white;
    }

    /* Nuevos estilos para mejoras solicitadas */
    
    /* Mejoras de legibilidad - T√≠tulos */
    h1, h2, h3, h4, h5, h6 {
      color: var(--text);
    }
    
    h2 {
      font-size: 1.75rem; /* 28px */
    }
    
    /* Iconos en splash */
    .feature-icons {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .feature-icon {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .feature-icon .icon {
      font-size: 1.5rem;
    }
    
    /* Indicadores de tendencia de precios */
    .trend-up {
      color: #f44336;
    }
    
    .trend-down {
      color: var(--success);
    }
    
    /* Indicadores de oferta confiable */
    .offer-high {
      background: rgba(67, 160, 71, 0.1);
      color: var(--success);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 700;
    }
    
    .offer-medium {
      background: rgba(255, 152, 0, 0.1);
      color: #ff9800;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 700;
    }
    
    .offer-low {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 700;
    }
    
    /* Gr√°fico de comparaci√≥n - ESTILOS CORREGIDOS */
    .comparison-chart {
      display: flex;
      align-items: flex-end;
      height: 150px;
      gap: 10px;
      margin: 20px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    
    .chart-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
    }
    
    .bar {
      width: 100%;
      border-radius: 4px 4px 0 0;
      transition: height 0.3s ease;
      min-height: 20px;
    }
    
    .bar-label {
      margin-top: 8px;
      font-size: 0.8rem;
      text-align: center;
    }
    
    /* Selector de modo de b√∫squeda */
    .search-mode-selector {
      display: flex;
      gap: 10px;
      margin: 16px 0;
    }
    
    .search-mode {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .search-mode.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      font-weight: normal;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Filtros de mapa */
    .map-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    /* Indicador de estado del chatbot */
    .chat-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(67, 160, 71, 0.1);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--success);
    }
    
    /* Preferencias mejoradas */
    .preferences-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
    }
    
    .preference-item {
      margin-bottom: 16px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      outline: none;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }
    
    .notification-channels {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    
    .notification-channel {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .notification-channel.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: 10px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Vista compacta vs detallada */
    .view-toggle {
      display: flex;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.08);
      width: fit-content;
    }
    
    .view-option {
      padding: 8px 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .view-option.active {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand" onclick="goHome()">
      <div class="logo">
        <img src="https://i.ibb.co/xq6VXvy0/solo-logo-sin-bg.png" alt="SmartPrice" style="width:32px; height:32px;">
      </div>
      <div class="title">SmartPrice</div>
    </div>

    <div class="search-wrap">
      <input id="globalSearch" class="search-input" placeholder="Buscar productos (ej.: leche, huevo, frijol)..." onkeydown="if(event.key==='Enter'){ doSearchFromTop() }">
    </div>

    <div class="navlinks" id="topNav">
      <button onclick="navigate('home')" class="active" title="P√°gina de inicio">üè† Inicio</button>
      <button onclick="navigate('search')" title="Buscar productos">üîç Buscar</button>
      <button onclick="navigate('compare')" title="Comparar precios entre tiendas">üìä Comparar Precios</button>
      <button onclick="navigate('map')" title="Mapa de tiendas">üó∫Ô∏è Mapa</button>
      <button onclick="navigate('cart')" title="Carrito de compras">üõí Carrito <span id="badgeCart" style="background:rgba(30,136,229,0.1); color:var(--accent); padding:4px 8px; border-radius:999px; margin-left:6px; font-weight:700;">0</span></button>
      <button onclick="navigate('profile')" title="Mi perfil">üë§ Perfil</button>
      <button class="btn-primary" onclick="navigate('chat')" title="Asistente virtual">üí¨ Chat <span class="chat-status">üü¢ Activo</span></button>
    </div>
  </header>

  <!-- BOTTOM NAVIGATION - MOBILE -->
  <div class="bottom-nav" id="bottomNav">
    <button onclick="navigate('home')" class="active">üè†<span>Inicio</span></button>
    <button onclick="navigate('search')">üîç<span>Buscar</span></button>
    <button onclick="navigate('compare')">üìä<span>Comparar</span></button>
    <button onclick="navigate('cart')">üõí<span id="mobileBadgeCart">Carrito</span></button>
    <button onclick="navigate('profile')">üë§<span>Perfil</span></button>
  </div>

  <!-- CONTENT -->
  <div class="wrap">

    <!-- SPLASH -->
    <section id="splash" class="app-section active">
      <div class="splash">
        <div style="max-width:62%;">
          <h1>SmartPrice ‚Äî Tu compra inteligente</h1>
          <p>Compara precios en tiempo real, recibe alertas personalizadas y ahorra en tu compra semanal. Integrado con 5 supermercados principales.</p>

          <div style="display:flex; gap:12px; margin-top:16px;">
            <button class="btn-primary" onclick="navigate('home')">Explorar productos</button>
            <button class="btn-ghost" onclick="navigate('login')">Iniciar sesi√≥n</button>
          </div>
          
          <!-- Iconos visuales para Comparar, Ahorrar, Encontrar -->
          <div class="feature-icons">
            <div class="feature-icon">
              <div class="icon">üìä</div>
              <div>
                <div style="font-weight:700;">Comparar</div>
                <div class="small">Precios en m√∫ltiples tiendas</div>
              </div>
            </div>
            <div class="feature-icon">
              <div class="icon">üí∞</div>
              <div>
                <div style="font-weight:700;">Ahorrar</div>
                <div class="small">Hasta un 30% en tu compra</div>
              </div>
            </div>
            <div class="feature-icon">
              <div class="icon">üîç</div>
              <div>
                <div style="font-weight:700;">Encontrar</div>
                <div class="small">Las mejores ofertas cerca</div>
              </div>
            </div>
          </div>
        </div>

        <div style="width:36%; display:flex; justify-content:center;">
          <div class="card" style="width:100%; text-align:center; padding:20px;">
            <img src="https://i.ibb.co/0RhB3WCm/logo-y-nombre-redimensionado-removebg-preview.png" alt="SmartPrice Demo" style="width:100%; height:240px; border-radius:12px; margin-bottom:16px; object-fit:cover;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="text-align:left">
                <div style="font-weight:800; font-size:1.05rem">SmartPrice Pro</div>
                <div class="small muted">Comparaci√≥n en tiempo real</div>
              </div>
              <div>
                <div style="font-weight:800; color:var(--accent);">M√©rida</div>
                <div class="small muted">5 tiendas cerca</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="login" class="app-section">
      <div class="card">
        <div style="display:flex; gap:24px; align-items:center; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <h2 style="margin:0 0 10px 0">Iniciar sesi√≥n</h2>
            <p class="muted small">Usa cualquier correo para simular el inicio de sesi√≥n (se guarda en localStorage).</p>

            <div style="margin-top:16px;">
              <label class="small muted">Correo</label><br>
              <input id="inputEmail" type="email" placeholder="tu@correo.com" style="width:100%; padding:14px; border-radius:12px; border:1px solid rgba(0,0,0,0.08); background:white; color:var(--text); margin-top:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            </div>
            <div style="margin-top:16px;">
              <label class="small muted">Contrase√±a</label><br>
              <input id="inputPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:14px; border-radius:12px; border:1px solid rgba(0,0,0,0.08); background:white; color:var(--text); margin-top:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            </div>

            <div style="display:flex; gap:10px; margin-top:18px;">
              <button class="btn-primary" onclick="login()">Entrar</button>
              <button class="btn-ghost" onclick="loginAsGuest()">Entrar como invitado</button>
            </div>
            <div id="loginMsg" class="small muted mt-12" style="margin-top:12px;"></div>
          </div>

          <div style="width:360px;">
            <div style="background:white; padding:16px; border-radius:12px; box-shadow: var(--shadow);">
              <h4 style="margin:0 0 8px 0">Beneficios Premium</h4>
              <ul class="muted small" style="margin:10px 0 0 20px;">
                <li>Historial de precios de 12 meses</li>
                <li>Alertas personalizadas de ofertas</li>
                <li>Predicciones de precios con IA</li>
                <li>Listas de compra inteligentes</li>
              </ul>
            </div>
            <div style="margin-top:16px; font-size:0.85rem;" class="muted">Nota: Este inicio es simulado para la demostraci√≥n; los datos se guardan localmente en tu navegador.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME / PRODUCTOS -->
    <section id="home" class="app-section">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0">Productos destacados</h2>
          <div class="small muted">Precios actualizados hace 30 minutos ‚Ä¢ 5 supermercados integrados</div>
        </div>
        <div style="display:flex; gap:10px;">
          <input id="filterInput" class="search-input" placeholder="Filtrar por nombre o categor√≠a" onkeydown="if(event.key==='Enter') filterProducts()">
          <button class="btn-ghost" onclick="filterProducts()">Filtrar</button>
          <button class="btn-primary" onclick="navigate('compare')">Ir a comparar</button>
        </div>
      </div>

      <div id="productsGrid" class="product-grid mt-12">
        <!-- productos generados por JS -->
      </div>
    </section>

    <!-- SEARCH (vista m√°s completa) -->
    <section id="search" class="app-section">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0">Buscar productos</h2>
          <div class="small muted">Filtrado avanzado y resultados en tiempo real</div>
        </div>
        <div style="display:flex; gap:10px;">
          <select id="catFilter" style="padding:12px; border-radius:12px; background:white; border:1px solid rgba(0,0,0,0.08); color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <option value="">Todas las categor√≠as</option>
          </select>
          <select id="storeFilter" style="padding:12px; border-radius:12px; background:white; border:1px solid rgba(0,0,0,0.08); color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <option value="">Todas las tiendas</option>
          </select>
          <input id="searchBox" class="search-input" placeholder="Buscar..." onkeydown="if(event.key==='Enter') doSearch()">
          <button class="btn-primary" onclick="doSearch()">Buscar</button>
        </div>
      </div>

      <div id="searchResults" class="mt-12">
        <!-- resultados -->
      </div>
    </section>

    <!-- COMPARE -->
    <section id="compare" class="app-section">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0">Comparar precios por tienda</h2>
          <div class="small muted">Selecciona un producto para ver precios en diferentes tiendas</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <select id="compareProduct" style="padding:12px; border-radius:12px; background:white; border:1px solid rgba(0,0,0,0.08); color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);"></select>
          <button class="btn-primary" onclick="doCompare()">Comparar</button>
        </div>
      </div>
      
      <!-- Selector de modo de b√∫squeda -->
      <div class="search-mode-selector">
        <div class="search-mode active" onclick="setSearchMode('price')">üí∞ Mejor Precio</div>
        <div class="search-mode" onclick="setSearchMode('distance')">üìç M√°s Cercano</div>
        <div class="search-mode" onclick="setSearchMode('balance')">‚öñÔ∏è Balance</div>
      </div>

      <div id="compareResult" class="mt-12">
        <!-- resultado de comparaci√≥n -->
      </div>
    </section>

    <!-- PRODUCT DETAIL -->
    <section id="product" class="app-section">
      <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <div style="flex: 1 1 340px;">
          <div class="card" id="productCard">
            <div id="detailImage" class="product-image"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div id="detailTitle" style="font-weight:800; font-size:1.25rem"></div>
                <div class="small muted" id="detailCategory"></div>
              </div>
              <div style="text-align:right">
                <div class="price" id="detailPrice"></div>
                <div class="small muted" id="detailStore"></div>
              </div>
            </div>

            <p class="muted small mt-12" id="detailDesc"></p>
            
            <!-- Predicci√≥n de precios -->
            <div id="pricePrediction" style="margin-top:12px; display:none;">
              <div class="prediction-badge">Predicci√≥n: Precio bajar√° en 7 d√≠as</div>
              <div style="margin-top:6px;">
                <div class="small muted">Confianza: 85%</div>
                <div class="confidence-bar">
                  <div class="confidence-fill high-confidence"></div>
                </div>
              </div>
            </div>

            <!-- Validaci√≥n -->
            <div id="priceValidation" style="margin-top:12px; display:none;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="badge badge-success">‚≠ê Validado Profeco</span>
                <span class="small muted">Coincide con fuentes oficiales</span>
              </div>
            </div>

            <!-- Precio actualizado -->
            <div id="priceUpdated" style="margin-top:8px;">
              <span class="badge badge-info">Precio Actualizado: Hace 30 min</span>
            </div>

            <div style="display:flex; gap:10px; margin-top:16px;">
              <button class="btn-primary" id="btnAddDetail" onclick="">A√±adir al carrito</button>
              <button class="btn-ghost" onclick="followProduct(currentOpenProduct)">Seguir producto</button>
            </div>
            
            <!-- Reportar precio incorrecto -->
            <div style="margin-top:12px;">
              <button class="btn-ghost small" onclick="toggleReportForm()">Reportar precio incorrecto</button>
              <div id="reportForm" class="report-form" style="display:none;">
                <h5 style="margin:0 0 10px 0;">Reportar precio incorrecto</h5>
                <div style="margin-bottom:10px;">
                  <label class="small muted">Tienda</label>
                  <select style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); margin-top:4px;">
                    <option>Walmart Altabrisa</option>
                    <option>Soriana Montejo</option>
                    <option>Chedraui Itzaes</option>
                  </select>
                </div>
                <div style="margin-bottom:10px;">
                  <label class="small muted">Precio real</label>
                  <input type="text" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); margin-top:4px;" placeholder="$0.00">
                </div>
                <div style="margin-bottom:10px;">
                  <label class="small muted">Evidencia (opcional)</label>
                  <input type="file" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); margin-top:4px;">
                </div>
                <div style="display:flex; gap:8px;">
                  <button class="btn-primary small" onclick="submitReport()">Enviar reporte</button>
                  <button class="btn-ghost small" onclick="toggleReportForm()">Cancelar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="flex: 1 1 440px;">
          <div class="card">
            <h4 style="margin:0 0 8px 0">Precios en tiendas</h4>
            <div id="storesCompare" style="margin-top:10px;">
              <!-- lista tiendas -->
            </div>

            <div style="margin-top:12px;">
              <h5 style="margin:10px 0 8px 0">Historial de precios</h5>
              <div class="price-history">
                <div class="graph-container" id="priceHistoryGraph">
                  <!-- Gr√°fica ser√° generada por JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CART -->
    <section id="cart" class="app-section">
      <h2>Carrito de compras</h2>
      <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <div style="flex:1 1 640px;">
          <div id="cartItems" class="card">
            <!-- items -->
          </div>
        </div>

        <div style="width:340px;">
          <div class="card">
            <h4 style="margin:0 0 8px 0">Resumen de compra</h4>
            <div style="display:flex; justify-content:space-between; margin-top:16px;"><div class="muted">Subtotal</div><div id="cartSubtotal" style="font-weight:800;">$0.00</div></div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
              <div class="muted tooltip">Ahorro estimado
                <span class="tooltiptext">Ahorro basado en la diferencia de precios entre tiendas</span>
              </div>
              <div id="cartSaving" style="color: var(--success); font-weight: 700; font-size: 1.1rem;">$0.00</div>
            </div>
            <hr style="border-color:rgba(0,0,0,0.05)">
            <div style="display:flex; justify-content:space-between;"><div style="font-weight:800">Total</div><div id="cartTotal" style="font-weight:900; color:var(--accent-2); font-size: 1.2rem;">$0.00</div></div>
            <div style="margin-top:16px;">
              <button class="btn-primary" onclick="checkout()">Generar plan de compra</button>
              <button class="btn-ghost" style="margin-top:10px;" onclick="saveList()">Guardar lista</button>
            </div>
            <div style="margin-top:16px;" class="small muted">Mejor opci√≥n: <span id="bestShop">‚Äî</span></div>
          </div>
          
          <!-- Notificaciones separadas -->
          <div class="card" style="margin-top:16px;">
            <h4 style="margin:0 0 8px 0;">Alertas de precio</h4>
            <div id="priceAlerts">
              <div class="notification-item">
                <div style="font-weight:700; font-size:0.9rem;">üîî Leche Alpura 1L</div>
                <div class="small muted">Baj√≥ 12% en Walmart ‚Ä¢ Ahora $23.50</div>
              </div>
              <div class="notification-item">
                <div style="font-weight:700; font-size:0.9rem;">üí§ Huevo Blanco 30pz</div>
                <div class="small muted">Oferta especial en Soriana ‚Ä¢ $65.90</div>
              </div>
            </div>
            <button class="btn-ghost small" style="margin-top:10px; width:100%;">Configurar alertas</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section id="map" class="app-section">
      <h2>Mapa de tiendas</h2>
      <div class="card">
        <!-- Filtros de mapa -->
        <div class="map-filters">
          <button class="btn-ghost">üïí Abierto ahora</button>
          <button class="btn-ghost">üöö Env√≠o a domicilio</button>
          <button class="btn-primary">üí∞ Mejores precios</button>
        </div>
        
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1 1 580px;">
            <div class="map-container">
              <img src="https://cdn.computerhoy.com/sites/navi.axelspringer.es/public/media/image/2023/11/truco-secreto-google-maps-casi-nadie-conoce-puede-ayudarte-planificar-viajes-como-experto-3237494.jpg?tf=3840x" alt="Mapa de tiendas en M√©rida" style="width:100%; height:100%; object-fit:cover;">
              <div class="map-overlay">
                <div class="map-controls">
                  <div style="font-weight:700; margin-bottom:8px;">Mapa interactivo</div>
                  <div class="small muted">Ubicaci√≥n actual: M√©rida, Yucat√°n</div>
                  <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
                    <button class="btn-primary" onclick="focusStore(0)">Walmart Altabrisa</button>
                    <button class="btn-ghost" onclick="focusStore(1)">Soriana Montejo</button>
                    <button class="btn-ghost" onclick="focusStore(2)">Chedraui Itzaes</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="width:320px;">
            <h4 style="margin-top:0">Lista de tiendas</h4>
            <div id="storeList" style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
              <!-- tiendas -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="app-section">
      <h2>Mi perfil</h2>
      <div class="card" style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
        <div class="profile-card">
          <div class="avatar" id="avatarChar">J</div>
          <div>
            <div id="profileName" style="font-weight:800; font-size:1.15rem">Invitado</div>
            <div class="small muted" id="profileEmail">invitado@demo</div>
          </div>
        </div>

        <div style="flex:1; min-width:280px;">
          <label class="small muted">Nombre</label><br>
          <input id="profileInputName" style="width:100%; padding:12px; border-radius:10px; margin-top:8px; background:white; border:1px solid rgba(0,0,0,0.08); color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <label class="small muted" style="margin-top:10px; display:block;">Correo</label><br>
          <input id="profileInputEmail" style="width:100%; padding:12px; border-radius:1010px; margin-top:8px; background:white; border:1px solid rgba(0,0,0,0.08); color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <div style="display:flex; gap:10px; margin-top:12px;">
            <button class="btn-primary" onclick="saveProfile()">Guardar</button>
            <button class="btn-ghost" onclick="logout()">Cerrar sesi√≥n</button>
          </div>
        </div>

        <div style="width:260px;">
          <h4 style="margin:0 0 10px 0">Preferencias</h4>
          
          <!-- Control deslizante para radio de b√∫squeda -->
          <div class="preference-item">
            <div class="small muted">Radio de b√∫squeda:</div>
            <div class="slider-container">
              <input type="range" min="1" max="20" value="5" class="slider" id="searchRadius">
              <span id="radiusValue" class="small">5 km</span>
            </div>
          </div>
          
          <!-- Selector de canal de notificaciones -->
          <div class="preference-item">
            <div class="small muted">Canal de notificaciones:</div>
            <div class="notification-channels">
              <div class="notification-channel active">üîî Push</div>
              <div class="notification-channel">‚úâÔ∏è Email</div>
            </div>
          </div>
          
          <!-- Toggle para modo ahorro extremo -->
          <div class="preference-item">
            <div class="small muted">Modo ahorro extremo:
              <label class="toggle-switch">
                <input type="checkbox">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <!-- Preferencias de visualizaci√≥n -->
          <div class="preference-item">
            <div class="small muted">Vista de productos:</div>
            <div class="view-toggle">
              <div class="view-option active">Compacta</div>
              <div class="view-option">Detallada</div>
            </div>
          </div>
          
          <div class="small muted" style="margin-top:8px;">Supermercados favoritos:</div>
          <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
            <span class="badge badge-info">Walmart</span>
            <span class="badge badge-info">Soriana</span>
            <span class="badge">Chedraui</span>
            <span class="badge">Bodega Aurrera</span>
            <span class="badge">La Comer</span>
          </div>
        </div>
      </div>

      <div style="margin-top:18px;" id="followedArea">
        <h3 style="margin:0 0 8px 0">Productos seguidos</h3>
        <div id="followedList" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <!-- seguidos -->
        </div>
      </div>
    </section>

    <!-- CHAT -->
    <section id="chat" class="app-section">
      <h2>Asistente Virtual SmartPrice</h2>
      <div style="display:flex; gap:16px; flex-wrap:wrap;">
        <div style="flex:1 1 680px;">
          <div class="card">
            <!-- Header del chat mejorado -->
            <div style="padding:12px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;">
              <div style="width:12px; height:12px; border-radius:50%; background:var(--success);"></div>
              <strong>Asistente de Compras - Te ayudo a comparar precios</strong>
            </div>
            <div id="chatWindow" class="chat-window">
              <!-- Mensaje de bienvenida personalizado -->
              <div class="bubble bot" id="welcomeMessage">
                <div style="display:inline-block; width:24px; height:24px; background:linear-gradient(135deg,var(--accent),var(--accent-3)); border-radius:6px; margin-right:8px; text-align:center; line-height:24px; color:white; font-weight:bold;">SP</div>
                <strong>SmartPrice:</strong> ¬°Hola! Soy tu asistente de compras. ¬øEn qu√© puedo ayudarte hoy?
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px;">
              <input id="chatInput" style="flex:1; padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.08); background:white; color:var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.05);" placeholder="Escribe algo..." onkeydown="if(event.key==='Enter') sendChat()">
              <button class="btn-primary" onclick="sendChat()">Enviar</button>
            </div>
            <div class="small muted" style="margin-top:10px;">Ejemplos: "¬øD√≥nde est√° m√°s barata la leche?", "Mu√©strame ofertas de hoy", "Ay√∫dame a ahorrar en mi lista".</div>
            <div style="margin-top:12px; text-align:center;">
              <button class="btn-ghost small">üí¨ Hablar con humano</button>
            </div>
          </div>
        </div>

        <div style="width:320px;">
          <div class="card">
            <h4 style="margin:0">Preguntas r√°pidas</h4>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px;">
              <button class="btn-ghost" onclick="setChatExample('¬øD√≥nde est√° m√°s barata la leche?')">¬øD√≥nde est√° m√°s barata la leche?</button>
              <button class="btn-ghost" onclick="setChatExample('Mu√©strame ofertas de hoy')">Mu√©strame ofertas de hoy</button>
              <button class="btn-ghost" onclick="setChatExample('Ay√∫dame a ahorrar en mi lista')">Ay√∫dame a ahorrar en mi lista</button>
              <button class="btn-ghost" onclick="setChatExample('¬øQu√© productos tienen validaci√≥n?')">Productos validados</button>
            </div>
          </div>
          
          <div class="card" style="margin-top:16px;">
            <h4 style="margin:0 0 8px 0">Informaci√≥n de precios</h4>
            <div class="small muted">Consulta semanal a fuentes oficiales</div>
            <div style="margin-top:8px; display:flex; align-items:center; gap:6px;">
              <div style="width:8px; height:8px; border-radius:50%; background:var(--success);"></div>
              <span class="small">1,250 productos validados</span>
            </div>
            <div style="margin-top:4px; display:flex; align-items:center; gap:6px;">
              <div style="width:8px; height:8px; border-radius:50%; background:var(--accent);"></div>
              <span class="small">Actualizado: 24 horas</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <footer>
    ¬© 2025 SmartPrice ‚Äî Mockup interactivo ‚Ä¢ Cumple con est√°ndares de accesibilidad ‚Ä¢ Protecci√≥n de datos
  </footer>

  <!-- SCRIPT: L√≥gica del mockup -->
  <script>
    /* --------------------------
       Datos de ejemplo con URLs reales de im√°genes
       -------------------------- */
    const PRODUCTS = [
      { 
        id:1, 
        name:'Leche Alpura 1L', 
        category:'L√°cteos', 
        image:'https://lacentraldeabastos.com/wp-content/uploads/2024/10/photoroom_006_20241014_154037-1.jpg',
        description:'Leche entera pasteurizada 1L', 
        pricePerUnit: '$23.50/L',
        trend: 'down',
        validation: true,
        offerLevel: 'high', // high, medium, low
        stores:[
          {name:'Walmart Altabrisa', price:23.5, distance:1.2, offer:'üü¢', time: '15 min'}, 
          {name:'Soriana Montejo', price:24.3, distance:2.1, offer:'üü¢', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:22.9, distance:3.5, offer:'üü°', time: '35 min'}
        ]
      },
      { 
        id:2, 
        name:'Huevo Blanco 30pz', 
        category:'Abarrotes', 
        image:'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
        description:'Paquete de 30 huevos blancos', 
        pricePerUnit: '$2.20/pz',
        trend: 'stable',
        validation: true,
        offerLevel: 'medium',
        stores:[
          {name:'Walmart Altabrisa', price:68.5, distance:1.2, offer:'üü¢', time: '15 min'}, 
          {name:'Soriana Montejo', price:65.9, distance:2.1, offer:'üü°', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:70.2, distance:3.5, offer:'üü¢', time: '35 min'}
        ]
      },
      { 
        id:3, 
        name:'Frijol Negro 1kg', 
        category:'Legumbres', 
        image:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTSVYdquQdFsNzjTRoP--mEb9Lr2-gp2-4TkA&s',
        description:'Frijol negro 1kg', 
        pricePerUnit: '$38.00/kg',
        trend: 'up',
        validation: false,
        offerLevel: 'high',
        stores:[
          {name:'Walmart Altabrisa', price:38.0, distance:1.2, offer:'üü°', time: '15 min'}, 
          {name:'Soriana Montejo', price:35.5, distance:2.1, offer:'üü¢', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:36.8, distance:3.5, offer:'üü¢', time: '35 min'}
        ]
      },
      { 
        id:4, 
        name:'Arroz SOS 1kg', 
        category:'Granos', 
        image:'https://images.unsplash.com/photo-1586201375761-83865001e31c?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
        description:'Arroz blanco 1kg', 
        pricePerUnit: '$28.50/kg',
        trend: 'stable',
        validation: true,
        offerLevel: 'high',
        stores:[
          {name:'Walmart Altabrisa', price:28.5, distance:1.2, offer:'üü¢', time: '15 min'}, 
          {name:'Soriana Montejo', price:26.9, distance:2.1, offer:'üü¢', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:27.8, distance:3.5, offer:'üü°', time: '35 min'}
        ]
      },
      { 
        id:5, 
        name:'Aceite Capullo 1L', 
        category:'Aceites', 
        image:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpT7cxWcdH9F-5FMHQ-L6QZs7TZsXEHmYmGA&s',
        description:'Aceite vegetal 1L', 
        pricePerUnit: '$45.00/L',
        trend: 'stable',
        validation: false,
        offerLevel: 'medium',
        stores:[
          {name:'Walmart Altabrisa', price:45.0, distance:1.2, offer:'üü°', time: '15 min'}, 
          {name:'Soriana Montejo', price:42.5, distance:2.1, offer:'üü¢', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:43.8, distance:3.5, offer:'üü¢', time: '35 min'}
        ]
      },
      { 
        id:6, 
        name:'Pan Bimbo Grande', 
        category:'Panader√≠a', 
        image:'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
        description:'Pan de caja grande', 
        pricePerUnit: '$38.50/paq',
        trend: 'down',
        validation: false,
        offerLevel: 'medium',
        stores:[
          {name:'Walmart Altabrisa', price:38.5, distance:1.2, offer:'üü°', time: '15 min'}, 
          {name:'Soriana Montejo', price:36.9, distance:2.1, offer:'üü¢', time: '25 min'}, 
          {name:'Chedraui Itzaes', price:37.8, distance:3.5, offer:'üü°', time: '35 min'}
        ]
      }
    ];

    const STORES = [
      { name:'Walmart Altabrisa', lat:20.983113, lng:-89.624222, avg:'$$', hours:'üïí 8:00 - 22:00', traffic:'üü¢ Poca afluencia', services: ['Estacionamiento', 'Delivery', 'Recogida en tienda'] },
      { name:'Soriana Montejo', lat:20.987654, lng:-89.618765, avg:'$$', hours:'üïí 7:00 - 23:00', traffic:'üü° Afluencia media', services: ['Estacionamiento', 'Delivery'] },
      { name:'Chedraui Itzaes', lat:20.976543, lng:-89.632109, avg:'$', hours:'üïí 8:00 - 22:00', traffic:'üî¥ Mucha afluencia', services: ['Estacionamiento', 'Recogida en tienda'] },
      { name:'Bodega Aurrera', lat:20.981234, lng:-89.627891, avg:'$', hours:'üïí 7:00 - 21:00', traffic:'üü° Afluencia media', services: ['Estacionamiento'] },
      { name:'La Comer', lat:20.984567, lng:-89.621234, avg:'$$$', hours:'üïí 9:00 - 20:00', traffic:'üü¢ Poca afluencia', services: ['Estacionamiento', 'Delivery', 'Recogida en tienda', 'Productos gourmet'] }
    ];

    /* --------------------------
       Estado (localStorage)
       -------------------------- */
    const state = {
      cart: JSON.parse(localStorage.getItem('sp_cart') || '[]'),
      followed: JSON.parse(localStorage.getItem('sp_followed') || '[]'),
      user: JSON.parse(localStorage.getItem('sp_user') || 'null'),
      currentOpenProduct: null,
      searchMode: 'price' // price, distance, balance
    };

    function persist(){
      localStorage.setItem('sp_cart', JSON.stringify(state.cart));
      localStorage.setItem('sp_followed', JSON.stringify(state.followed));
      localStorage.setItem('sp_user', JSON.stringify(state.user));
      renderCartBadge();
    }

    /* --------------------------
       Navegaci√≥n SPA
       -------------------------- */
    function navigate(sectionId){
      document.querySelectorAll('section.app-section').forEach(s => s.classList.remove('active'));
      const s = document.getElementById(sectionId);
      if(s) s.classList.add('active');
      
      // Actualizar navegaci√≥n superior
      document.querySelectorAll('.navlinks button').forEach(b => b.classList.remove('active'));
      const navs = Array.from(document.querySelectorAll('.navlinks button')).find(b => {
        const text = b.textContent.trim();
        return text.includes(capitalize(sectionId)) || 
               (sectionId === 'home' && text.includes('Inicio')) ||
               (sectionId === 'search' && text.includes('Buscar')) ||
               (sectionId === 'compare' && text.includes('Comparar')) ||
               (sectionId === 'map' && text.includes('Mapa')) ||
               (sectionId === 'cart' && text.includes('Carrito')) ||
               (sectionId === 'profile' && text.includes('Perfil')) ||
               (sectionId === 'chat' && text.includes('Chat'));
      });
      if(navs) navs.classList.add('active');
      
      // Actualizar navegaci√≥n inferior
      document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
      const bottomNavs = Array.from(document.querySelectorAll('.bottom-nav button')).find(b => {
        const text = b.textContent.trim();
        return (sectionId === 'home' && text.includes('Inicio')) ||
               (sectionId === 'search' && text.includes('Buscar')) ||
               (sectionId === 'compare' && text.includes('Comparar')) ||
               (sectionId === 'cart' && text.includes('Carrito')) ||
               (sectionId === 'profile' && text.includes('Perfil'));
      });
      if(bottomNavs) bottomNavs.classList.add('active');
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // extra actions
      if(sectionId === 'home') renderProducts();
      if(sectionId === 'search') {
        populateCategoryFilter();
        populateStoreFilter();
      }
      if(sectionId === 'compare') populateCompareSelects();
      if(sectionId === 'cart') renderCart();
      if(sectionId === 'profile') renderProfile();
      if(sectionId === 'chat') updateChatWelcome();
    }

    function goHome(){ navigate('home'); }

    function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1); }

    /* --------------------------
       Render productos (home) con mejoras visuales
       -------------------------- */
    function renderProducts(list = PRODUCTS){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      list.forEach(p => {
        const hasValidation = p.validation;
        const trendIcon = p.trend === 'up' ? '‚ÜóÔ∏è' : (p.trend === 'down' ? '‚ÜòÔ∏è' : '');
        const offerLevel = p.offerLevel;
        const offerText = offerLevel === 'high' ? 'Oferta Confiable' : (offerLevel === 'medium' ? 'Oferta Media' : 'Oferta Baja');
        const offerBadgeClass = offerLevel === 'high' ? 'offer-high' : (offerLevel === 'medium' ? 'offer-medium' : 'offer-low');
        
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
          <img class="product-image" src="${p.image}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">
          <div class="product-info">
            <div>
              <div class="product-title">${escapeHtml(p.name)} ${trendIcon}</div>
              <div class="product-cat">${escapeHtml(p.category)}</div>
              ${hasValidation ? '<span class="badge badge-success">‚≠ê Validado Profeco</span>' : ''}
              <span class="${offerBadgeClass}">${offerText}</span>
            </div>
            <div class="product-row">
              <div>
                <div class="price">$${p.stores[0].price.toFixed(2)}</div>
                <div class="store">${escapeHtml(p.stores[0].name)}</div>
                <div class="small muted">${p.pricePerUnit}</div>
              </div>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-primary" onclick="openProduct(${p.id})">Ver</button>
                <button class="btn-ghost" onclick="addToCart(${p.id})">A√±adir</button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(div);
      });
    }

    /* --------------------------
       Filtrado y b√∫squeda
       -------------------------- */
    function filterProducts(){
      const q = (document.getElementById('filterInput').value || '').trim().toLowerCase();
      const res = PRODUCTS.filter(p => p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q));
      renderProducts(res);
      if(res.length === 0){
        document.getElementById('productsGrid').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-title">No se encontraron productos</div>
            <div class="empty-state-description">No hay productos que coincidan con "<strong>${escapeHtml(q)}</strong>"</div>
            <button class="btn-primary" onclick="document.getElementById('filterInput').value=''; filterProducts();">Mostrar todos</button>
          </div>
        `;
      }
    }

    function doSearch(){
      const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();
      const cat = (document.getElementById('catFilter').value || '').trim().toLowerCase();
      const store = (document.getElementById('storeFilter').value || '').trim().toLowerCase();
      const results = PRODUCTS.filter(p => {
        const matchQ = q === '' || p.name.toLowerCase().includes(q) || p.description.toLowerCase().includes(q);
        const matchCat = cat === '' || p.category.toLowerCase() === cat;
        const matchStore = store === '' || p.stores.some(s => s.name.toLowerCase().includes(store));
        return matchQ && matchCat && matchStore;
      });
      const container = document.getElementById('searchResults');
      container.innerHTML = '';
      if(results.length === 0){
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-title">No hay resultados</div>
            <div class="empty-state-description">Intenta con otros t√©rminos de b√∫squeda</div>
          </div>
        `;
        return;
      }
      results.forEach(p => {
        const el = document.createElement('div');
        el.className = 'product-card';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.innerHTML = `
          <img src="${p.image}" style="width:180px; height:120px; object-fit:cover; border-radius:10px; margin-right:16px;" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">
          <div style="flex:1; padding:16px 10px;">
            <div style="font-weight:800">${escapeHtml(p.name)}</div>
            <div class="muted small">${escapeHtml(p.category)}</div>
            <div style="margin-top:10px;">
              <button class="btn-primary" onclick="openProduct(${p.id})">Ver</button>
              <button class="btn-ghost" onclick="addToCart(${p.id})">A√±adir</button>
            </div>
          </div>
        `;
        container.appendChild(el);
      });
    }

    function doSearchFromTop(){
      const q = (document.getElementById('globalSearch').value || '').trim();
      document.getElementById('searchBox').value = q;
      navigate('search');
      setTimeout(doSearch, 10);
    }

    function populateCategoryFilter(){
      const select = document.getElementById('catFilter');
      if(!select) return;
      const cats = Array.from(new Set(PRODUCTS.map(p => p.category)));
      select.innerHTML = '<option value="">Todas las categor√≠as</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }
    
    function populateStoreFilter(){
      const select = document.getElementById('storeFilter');
      if(!select) return;
      const stores = Array.from(new Set(PRODUCTS.flatMap(p => p.stores.map(s => s.name))));
      select.innerHTML = '<option value="">Todas las tiendas</option>' + stores.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    }

    /* --------------------------
       Product detail con mejoras visuales
       -------------------------- */
    let currentOpenProduct = null;
    function openProduct(id){
      const p = PRODUCTS.find(x => x.id === id);
      if(!p) return;
      currentOpenProduct = id;
      
      // Actualizar imagen
      const detailImage = document.getElementById('detailImage');
      detailImage.innerHTML = `<img src="${p.image}" alt="${escapeHtml(p.name)}" style="width:100%; height:100%; object-fit:cover;" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">`;
      
      document.getElementById('detailTitle').textContent = p.name;
      document.getElementById('detailCategory').textContent = p.category;
      document.getElementById('detailPrice').textContent = '$' + p.stores[0].price.toFixed(2);
      document.getElementById('detailStore').textContent = p.stores[0].name;
      document.getElementById('detailDesc').textContent = p.description;
      document.getElementById('btnAddDetail').onclick = () => addToCart(p.id);
      
      // Mostrar predicci√≥n de precios para algunos productos
      if(id === 1 || id === 3) {
        document.getElementById('pricePrediction').style.display = 'block';
      } else {
        document.getElementById('pricePrediction').style.display = 'none';
      }
      
      // Mostrar validaci√≥n para algunos productos
      if(id === 2 || id === 4) {
        document.getElementById('priceValidation').style.display = 'block';
      } else {
        document.getElementById('priceValidation').style.display = 'none';
      }
      
      // tiendas
      const div = document.getElementById('storesCompare'); div.innerHTML = '';
      p.stores.forEach((s, idx) => {
        const r = document.createElement('div');
        r.className = 'product-row';
        r.style.padding = '10px 0';
        r.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(s.name)} ${idx===0 ? '<span class="small" style="color:var(--success); font-weight:700;">‚Ä¢ Mejor</span>' : ''}</div>
            <div class="small muted">${s.distance} km ‚Ä¢ ${s.time} ‚Ä¢ ${s.offer}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">$${s.price.toFixed(2)}</div>
            <div style="margin-top:8px;"><button class="btn-ghost" onclick="addToCart(${p.id})">A√±adir</button></div>
          </div>
        `;
        div.appendChild(r);
      });
      
      // Generar gr√°fica de historial de precios
      generatePriceHistoryGraph(p.id);
      
      navigate('product');
    }
    
    function toggleReportForm() {
      const form = document.getElementById('reportForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
    
    function submitReport() {
      toast('Reporte enviado. Gracias por colaborar.', 'success');
      toggleReportForm();
    }

    /* --------------------------
       Cart con mejoras visuales
       -------------------------- */
    function addToCart(id){
      const p = PRODUCTS.find(x => x.id === id);
      if(!p) return;
      const item = state.cart.find(i => i.id === id);
      if(item) item.qty++;
      else state.cart.push({ id: id, qty: 1, price: p.stores[0].price, name: p.name });
      persist();
      renderCart();
      toast('Producto a√±adido al carrito', 'success');
    }

    function renderCart(){
      const container = document.getElementById('cartItems');
      container.innerHTML = '';
      if(state.cart.length === 0){
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõí</div>
            <div class="empty-state-title">Tu carrito est√° vac√≠o</div>
            <div class="empty-state-description">Agrega algunos productos para comenzar</div>
            <button class="btn-primary" onclick="navigate('home')">Explorar productos</button>
          </div>
        `;
        updateTotals();
        return;
      }
      state.cart.forEach(ci => {
        const p = PRODUCTS.find(x => x.id === ci.id);
        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <img src="${p.image}" style="width:100px; height:75px; object-fit:cover; border-radius:12px;" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">
          <div style="flex:1">
            <div style="font-weight:800">${escapeHtml(p.name)}</div>
            <div class="small muted">${escapeHtml(p.stores[0].name)}</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px; width:160px; justify-content:center;">
            <button class="btn-ghost" onclick="changeQty(${ci.id}, -1)">-</button>
            <div>${ci.qty}</div>
            <button class="btn-ghost" onclick="changeQty(${ci.id}, 1)">+</button>
          </div>
          <div style="width:140px; text-align:right;">
            <div style="font-weight:800">$${(ci.price * ci.qty).toFixed(2)}</div>
            <div><button class="btn-ghost" onclick="removeFromCart(${ci.id})">Eliminar</button></div>
          </div>
        `;
        container.appendChild(el);
      });
      updateTotals();
    }

    function changeQty(id, delta){
      const item = state.cart.find(i => i.id === id);
      if(!item) return;
      item.qty += delta;
      if(item.qty <= 0) state.cart = state.cart.filter(i => i.id !== id);
      persist();
      renderCart();
    }

    function removeFromCart(id){
      state.cart = state.cart.filter(i => i.id !== id);
      persist();
      renderCart();
    }

    function updateTotals(){
      const sub = state.cart.reduce((s, i) => s + i.qty * i.price, 0);
      const saving = Math.round(sub * 0.08 * 100) / 100;
      const total = Math.round((sub - saving) * 100) / 100;
      document.getElementById('cartSubtotal').textContent = `$${sub.toFixed(2)}`;
      document.getElementById('cartSaving').textContent = `$${saving.toFixed(2)}`;
      document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
      document.getElementById('bestShop').textContent = state.cart.length ? 'Walmart Altabrisa ‚Äî 1.2 km' : '‚Äî';
      renderCartBadge();
    }

    function checkout(){
      if(state.cart.length === 0){ toast('El carrito est√° vac√≠o', 'error'); return; }
      toast('Plan de compra generado (simulado).', 'success');
      state.cart = [];
      persist();
      renderCart();
      navigate('home');
    }

    function saveList(){
      toast('Lista guardada en tu cuenta (simulado).', 'success');
    }

    function renderCartBadge(){
      const count = state.cart.reduce((s,i) => s + i.qty, 0);
      document.getElementById('badgeCart').textContent = count;
      document.getElementById('mobileBadgeCart').textContent = count > 0 ? `Carrito (${count})` : 'Carrito';
    }

    /* --------------------------
       Comparison con gr√°fica visual
       -------------------------- */
    function populateCompareSelects(){
      const select = document.getElementById('compareProduct');
      select.innerHTML = PRODUCTS.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    }

    function setSearchMode(mode) {
      state.searchMode = mode;
      
      // Actualizar UI
      document.querySelectorAll('.search-mode').forEach(el => {
        el.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Re-ejecutar comparaci√≥n si hay un producto seleccionado
      const productId = parseInt(document.getElementById('compareProduct').value,10);
      if(productId) {
        doCompare();
      }
    }

    function doCompare(){
      const productId = parseInt(document.getElementById('compareProduct').value,10);
      const product = PRODUCTS.find(p => p.id === productId);
      
      if(!product) {
        document.getElementById('compareResult').innerHTML = '<div class="card" style="text-align:center;">Selecciona un producto para comparar.</div>'; 
        return;
      }
      
      // Ordenar tiendas seg√∫n el modo de b√∫squeda
      let sortedStores = [...product.stores];
      
      switch(state.searchMode) {
        case 'price':
          sortedStores.sort((a, b) => a.price - b.price);
          break;
        case 'distance':
          sortedStores.sort((a, b) => a.distance - b.distance);
          break;
        case 'balance':
          // Ordenar por una combinaci√≥n de precio y distancia
          sortedStores.sort((a, b) => {
            const scoreA = (a.price / Math.max(...sortedStores.map(s => s.price))) + (a.distance / Math.max(...sortedStores.map(s => s.distance)));
            const scoreB = (b.price / Math.max(...sortedStores.map(s => s.price))) + (b.distance / Math.max(...sortedStores.map(s => s.distance)));
            return scoreA - scoreB;
          });
          break;
      }
      
      // Crear gr√°fica de barras horizontal - C√ìDIGO CORREGIDO
      const maxPrice = Math.max(...sortedStores.map(s => s.price));
      const minPrice = Math.min(...sortedStores.map(s => s.price));
      
      let html = `
        <div class="card">
          <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
            <img src="${product.image}" style="width:120px; height:90px; object-fit:cover; border-radius:10px;" alt="${escapeHtml(product.name)}" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">
            <div>
              <div style="font-weight:800; font-size:1.2rem">${escapeHtml(product.name)}</div>
              <div class="muted small">${escapeHtml(product.category)}</div>
            </div>
          </div>
          
          <h4 style="margin:0 0 12px 0;">Comparaci√≥n de precios por tienda</h4>
          
          <!-- Gr√°fica de barras horizontal - C√ìDIGO CORREGIDO -->
          <div style="margin-top: 20px;">
            <h5 style="margin:0 0 10px 0;">Comparaci√≥n Visual de Precios</h5>
            <div class="comparison-chart">
              ${sortedStores.map((store, index) => {
                // Calcular altura de la barra basada en el precio relativo
                const priceRange = maxPrice - minPrice;
                const barHeight = priceRange > 0 ? ((store.price - minPrice) / priceRange) * 100 : 50;
                const isBest = index === 0;
                return `
                  <div class="chart-bar">
                    <div class="bar" style="height: ${barHeight}%; background: ${isBest ? 'var(--success)' : 'var(--accent)'};"></div>
                    <div class="bar-label">
                      <div style="font-weight:700;">$${store.price.toFixed(2)}</div>
                      <div class="small">${escapeHtml(store.name)}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Tienda</th>
                <th>Precio</th>
                <th>Distancia</th>
                <th>Tiempo</th>
                <th>Oferta</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              ${sortedStores.map((store, index) => `
                <tr ${index === 0 ? 'class="best"' : ''}>
                  <td>${escapeHtml(store.name)}</td>
                  <td style="font-weight:800; color:var(--accent-2);">$${store.price.toFixed(2)}</td>
                  <td>${store.distance} km</td>
                  <td>${store.time}</td>
                  <td>${store.offer}</td>
                  <td><button class="btn-ghost small" onclick="addToCart(${product.id})">A√±adir</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div style="margin-top:16px; padding:12px; border-radius:10px; background: rgba(30,136,229,0.05);">
            <div style="font-weight:700; color:var(--accent);">Recomendaci√≥n:</div>
            <div class="small muted">${sortedStores[0].name} tiene el mejor precio ($${sortedStores[0].price.toFixed(2)}) con una distancia de ${sortedStores[0].distance} km.</div>
            ${sortedStores.length > 1 ? `<div class="small muted" style="margin-top:8px; color:var(--success); font-weight:700;">Ahorras $${(sortedStores[1].price - sortedStores[0].price).toFixed(2)} comprando en ${sortedStores[0].name}</div>` : ''}
          </div>
          
          <!-- Secci√≥n de predicci√≥n expandida -->
          <div style="margin-top:20px;">
            <h5 style="margin:0 0 10px 0;">Predicci√≥n de Precios</h5>
            <div style="display:flex; gap:20px; align-items:center;">
              <div style="flex:1;">
                <div class="prediction-badge">Precio bajar√° 5% en 7 d√≠as</div>
                <div style="margin-top:6px;">
                  <div class="small muted">Confianza: 85%</div>
                  <div class="confidence-bar">
                    <div class="confidence-fill high-confidence"></div>
                  </div>
                </div>
              </div>
              <div style="width:120px; height:80px; background:white; border-radius:8px; display:flex; align-items:center; justify-content:center; box-shadow: var(--shadow);">
                <div class="small muted">Gr√°fica mini</div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('compareResult').innerHTML = html;
    }

    /* --------------------------
       Stores / Map con informaci√≥n mejorada
       -------------------------- */
    function renderStores(){
      const list = document.getElementById('storeList');
      list.innerHTML = '';
      STORES.forEach((s, i) => {
        const el = document.createElement('div');
        el.style.padding = '12px';
        el.style.borderRadius = '10px';
        el.style.background = 'white';
        el.style.boxShadow = 'var(--shadow)';
        el.innerHTML = `
          <div style="font-weight:700">${escapeHtml(s.name)}</div>
          <div class="small muted">üìç ${s.lat.toFixed(3)}, ${s.lng.toFixed(3)} ‚Ä¢ ${s.avg}</div>
          <div class="small muted" style="margin-top:4px;">${s.hours}</div>
          <div class="small muted">${s.traffic}</div>
          <div class="small muted" style="margin-top:4px;">Servicios: ${s.services.join(', ')}</div>
          <div style="margin-top:10px;"><button class="btn-ghost" onclick="navigate('compare')">Ver productos</button> <button class="btn-ghost" onclick="focusStore(${i})">C√≥mo llegar</button></div>
        `;
        list.appendChild(el);
      });
    }

    function focusStore(i){
      navigate('map');
      toast('Centrando mapa en: ' + STORES[i].name + ' (simulado)', 'info');
    }

    /* --------------------------
       Profile & Followed
       -------------------------- */
    function renderProfile(){
      const u = state.user;
      const nameEl = document.getElementById('profileName'), emailEl = document.getElementById('profileEmail');
      const inputName = document.getElementById('profileInputName'), inputEmail = document.getElementById('profileInputEmail');
      if(u){
        nameEl.textContent = u.name || 'Usuario';
        emailEl.textContent = u.email || 'usuario@demo';
        inputName.value = u.name || '';
        inputEmail.value = u.email || '';
        document.getElementById('avatarChar').textContent = (u.name || 'U').charAt(0).toUpperCase();
      } else {
        nameEl.textContent = 'Invitado';
        emailEl.textContent = 'invitado@demo';
        inputName.value = '';
        inputEmail.value = '';
        document.getElementById('avatarChar').textContent = 'I';
      }
      renderFollowed();
    }

    function saveProfile(){
      const name = document.getElementById('profileInputName').value.trim();
      const email = document.getElementById('profileInputEmail').value.trim();
      if(!email.includes('@')){ toast('Correo inv√°lido', 'error'); return; }
      state.user = { name: name || 'Usuario', email: email };
      persist();
      renderProfile();
      toast('Perfil actualizado', 'success');
      // Actualizar el mensaje de bienvenida en el chat
      updateChatWelcome();
    }

    function renderFollowed(){
      const container = document.getElementById('followedList');
      container.innerHTML = '';
      if(state.followed.length === 0){ 
        container.innerHTML = `
          <div class="empty-state" style="padding: 20px; width: 100%;">
            <div class="empty-state-icon">‚≠ê</div>
            <div class="empty-state-title">No sigues productos</div>
            <div class="empty-state-description">Comienza a seguir productos para recibir notificaciones de precio</div>
          </div>
        `; 
        return; 
      }
      state.followed.forEach(id => {
        const p = PRODUCTS.find(x => x.id === id);
        if(!p) return;
        const el = document.createElement('div');
        el.style.minWidth = '200px';
        el.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; background: white; box-shadow: var(--shadow);">
            <img src="${p.image}" style="width:64px; height:50px; object-fit:cover; border-radius:8px;" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60';">
            <div style="flex:1;">
              <div style="font-weight:700">${escapeHtml(p.name)}</div>
              <div class="small muted">$${p.stores[0].price.toFixed(2)}</div>
            </div>
            <div><button class="btn-ghost" onclick="unfollow(${p.id})">Quitar</button></div>
          </div>
        `;
        container.appendChild(el);
      });
    }

    function followProduct(id){
      if(!state.followed.includes(id)){
        state.followed.push(id);
        persist();
        renderFollowed();
        toast('Ahora sigues el producto', 'success');
      } else {
        toast('Ya sigues este producto', 'info');
      }
    }
    function unfollow(id){
      state.followed = state.followed.filter(x => x !== id);
      persist();
      renderFollowed();
      toast('Producto dejado de seguir', 'info');
    }

    /* --------------------------
       Chat (simulado) con mejoras
       -------------------------- */
    function updateChatWelcome() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      const userName = state.user ? state.user.name : 'Invitado';
      welcomeMessage.innerHTML = `
        <div style="display:inline-block; width:24px; height:24px; background:linear-gradient(135deg,var(--accent),var(--accent-3)); border-radius:6px; margin-right:8px; text-align:center; line-height:24px; color:white; font-weight:bold;">SP</div>
        <strong>SmartPrice:</strong> ¬°Hola ${userName}! Soy tu asistente de compras. ¬øEn qu√© puedo ayudarte hoy?
      `;
    }
    
    function setChatExample(t){ document.getElementById('chatInput').value = t; }
    function sendChat(){
      const v = document.getElementById('chatInput').value.trim();
      if(!v) return;
      appendChat('user', v);
      document.getElementById('chatInput').value = '';
      
      // Mostrar indicador de procesamiento
      const w = document.getElementById('chatWindow');
      const processing = document.createElement('div');
      processing.className = 'bubble bot';
      processing.innerHTML = `<div style="display:inline-block; width:24px; height:24px; background:linear-gradient(135deg,var(--accent),var(--accent-3)); border-radius:6px; margin-right:8px; text-align:center; line-height:24px; color:white; font-weight:bold;">SP</div> <strong>SmartPrice:</strong> <span class="chat-status">ü§î Procesando...</span>`;
      w.appendChild(processing);
      w.scrollTop = w.scrollHeight;
      
      setTimeout(() => {
        // Remover el mensaje de procesamiento
        w.removeChild(processing);
        
        const m = v.toLowerCase();
        let resp = 'Lo siento, no tengo datos para eso.';
        if(m.includes('leche')) resp = 'La leche Alpura 1L est√° m√°s barata en Chedraui Itzaes a $22.90 (ahorro de $0.60 vs Walmart). Distancia: 3.5 km.';
        else if(m.includes('huevo')) resp = 'El huevo blanco 30pz tiene mejor precio en Soriana Montejo: $65.90. En Walmart cuesta $68.50.';
        else if(m.includes('frijol')) resp = 'El frijol negro 1kg est√° en oferta en Soriana Montejo por $35.50. Predicci√≥n: precio estable por 14 d√≠as.';
        else if(m.includes('arroz')) resp = 'El arroz SOS 1kg cuesta $26.90 en Soriana Montejo. Precio validado. Distancia: 2.1 km.';
        else if(m.includes('aceite')) resp = 'El aceite Capullo 1L tiene mejor precio en Soriana Montejo: $42.50. En Walmart cuesta $45.00.';
        else if(m.includes('oferta') || m.includes('ofertas')) resp = 'Ofertas destacadas hoy: Frijol negro en Soriana ($35.50), Huevo en Soriana ($65.90), Aceite en Soriana ($42.50).';
        else if(m.includes('validado') || m.includes('validaci√≥n')) resp = 'Productos con validaci√≥n esta semana: Huevo blanco 30pz, Arroz SOS 1kg, Leche Alpura 1L, Aceite Capullo 1L.';
        else if(m.includes('predicci√≥n') || m.includes('predecir')) resp = 'Basado en hist√≥rico de precios, predigo que la leche bajar√° 5% en 7 d√≠as y el huevo subir√° 3% en 14 d√≠as.';
        appendChat('bot', resp);
      }, 1500);
    }
    function appendChat(who, text){
      const w = document.getElementById('chatWindow');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
      if(who === 'bot') {
        b.innerHTML = `<div style="display:inline-block; width:24px; height:24px; background:linear-gradient(135deg,var(--accent),var(--accent-3)); border-radius:6px; margin-right:8px; text-align:center; line-height:24px; color:white; font-weight:bold;">SP</div> <strong>SmartPrice:</strong> ${escapeHtml(text)}`;
      } else {
        b.innerHTML = `<strong>T√∫:</strong> ${escapeHtml(text)}`;
      }
      w.appendChild(b);
      w.scrollTop = w.scrollHeight;
    }

    /* --------------------------
       Login & Auth
       -------------------------- */
    function login(){
      const email = document.getElementById('inputEmail').value.trim();
      const pass = document.getElementById('inputPass').value.trim();
      const msg = document.getElementById('loginMsg');
      if(!email || !email.includes('@')){ msg.textContent = 'Ingresa un correo v√°lido.'; return; }
      if(pass.length < 4){ msg.textContent = 'La contrase√±a debe tener al menos 4 caracteres.'; return; }
      state.user = { name: email.split('@')[0], email: email };
      persist();
      msg.textContent = '';
      toast('Sesi√≥n iniciada', 'success');
      renderProfile();
      updateChatWelcome();
      navigate('home');
    }

    function loginAsGuest(){
      state.user = { name: 'Invitado', email: 'invitado@demo' };
      persist();
      toast('Entraste como invitado', 'success');
      renderProfile();
      updateChatWelcome();
      navigate('home');
    }

    function logout(){
      state.user = null;
      persist();
      toast('Sesi√≥n cerrada', 'info');
      navigate('splash');
      renderProfile();
      updateChatWelcome();
    }

    /* --------------------------
       Gr√°ficas de historial de precios
       -------------------------- */
    function generatePriceHistoryGraph(productId) {
      const graphContainer = document.getElementById('priceHistoryGraph');
      
      // Limpiar el contenedor
      graphContainer.innerHTML = '';
      
      // Asegurarnos de que el contenedor tenga dimensiones
      if (graphContainer.offsetWidth === 0 || graphContainer.offsetHeight === 0) {
        // Si no tiene dimensiones, esperar un poco y reintentar
        setTimeout(() => generatePriceHistoryGraph(productId), 100);
        return;
      }
      
      // Datos simulados para el historial de precios
      const priceHistory = [
        { month: 'Ene', price: 25.50 },
        { month: 'Feb', price: 24.80 },
        { month: 'Mar', price: 24.20 },
        { month: 'Abr', price: 23.90 },
        { month: 'May', price: 23.50 },
        { month: 'Jun', price: 23.50 }
      ];
      
      // Encontrar valores m√≠nimos y m√°ximos para escalar la gr√°fica
      const prices = priceHistory.map(p => p.price);
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);
      const priceRange = maxPrice - minPrice;
      
      // Dimensiones del gr√°fico
      const width = graphContainer.offsetWidth;
      const height = graphContainer.offsetHeight;
      const padding = 20;
      
      // Crear elemento SVG
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      
      // Crear l√≠nea de la gr√°fica
      let pathData = '';
      priceHistory.forEach((point, index) => {
        const x = padding + (index * (width - 2 * padding) / (priceHistory.length - 1));
        const y = height - padding - ((point.price - minPrice) / priceRange * (height - 2 * padding));
        
        if (index === 0) {
          pathData += `M ${x} ${y} `;
        } else {
          pathData += `L ${x} ${y} `;
        }
      });
      
      // Crear √°rea bajo la curva
      let areaData = pathData;
      areaData += `L ${width - padding} ${height - padding} L ${padding} ${height - padding} Z`;
      
      // A√±adir √°rea
      const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      area.setAttribute('d', areaData);
      area.setAttribute('class', 'graph-area');
      svg.appendChild(area);
      
      // A√±adir l√≠nea
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      line.setAttribute('d', pathData);
      line.setAttribute('class', 'graph-line');
      svg.appendChild(line);
      
      // A√±adir puntos
      priceHistory.forEach((point, index) => {
        const x = padding + (index * (width - 2 * padding) / (priceHistory.length - 1));
        const y = height - padding - ((point.price - minPrice) / priceRange * (height - 2 * padding));
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 4);
        circle.setAttribute('class', 'graph-point');
        svg.appendChild(circle);
        
        // A√±adir etiquetas de mes
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', height - 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('font-size', '10');
        text.setAttribute('fill', '#546e7a');
        text.textContent = point.month;
        svg.appendChild(text);
        
        // A√±adir etiquetas de precio
        const priceText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        priceText.setAttribute('x', x);
        priceText.setAttribute('y', y - 8);
        priceText.setAttribute('text-anchor', 'middle');
        priceText.setAttribute('font-size', '9');
        priceText.setAttribute('fill', '#1e88e5');
        priceText.setAttribute('font-weight', 'bold');
        priceText.textContent = `$${point.price}`;
        svg.appendChild(priceText);
      });
      
      graphContainer.appendChild(svg);
    }

    /* --------------------------
       Utilities mejoradas
       -------------------------- */
    function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"'`]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]; }); }

    function toast(msg, type = 'info'){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = `toast ${type}`;
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity = '0', 2200);
      setTimeout(()=> { if(t.parentNode) document.body.removeChild(t); }, 2600);
    }

    /* --------------------------
       Small helpers on load
       -------------------------- */
    function init(){
      renderProducts();
      populateCategoryFilter();
      populateStoreFilter();
      populateCompareSelects();
      renderStores();
      renderProfile();
      renderCartBadge();
      updateChatWelcome();
      
      // Configurar control deslizante de radio de b√∫squeda
      const slider = document.getElementById('searchRadius');
      const output = document.getElementById('radiusValue');
      if (slider && output) {
        slider.addEventListener('input', function() {
          output.textContent = this.value + ' km';
        });
      }
      
      // keep initial nav highlighting
      document.querySelectorAll('.navlinks button')[0].classList.add('active');
      document.querySelectorAll('.bottom-nav button')[0].classList.add('active');
    }
    window.addEventListener('load', init);
  </script>
</body>
</html>
